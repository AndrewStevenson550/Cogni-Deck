<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniDeck - AI Study Sets</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- pdf.js (for client-side PDF reading) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    </script>
    
    <!-- Confetti (for celebrations) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config & Dark Mode Setup -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    // Custom styles for 3D card flip
                    transitionProperty: {
                        'transform': 'transform',
                    },
                    transformStyle: {
                        'preserve-3d': 'preserve-3d',
                    },
                    backfaceVisibility: {
                        'hidden': 'hidden',
                    },
                    rotate: {
                        'y-180': 'rotateY(180deg)',
                    },
                },
            },
            plugins: [
                function({ addUtilities }) {
                    addUtilities({
                        '.[transform-style\\:preserve-3d]': {
                            'transform-style': 'preserve-3d',
                        },
                        '.[backface-visibility\\:hidden]': {
                            'backface-visibility': 'hidden',
                        },
                        '.[transform\\:rotateY\\(180deg\\)]': {
                            'transform': 'rotateY(180deg)',
                        },
                        '.line-clamp-2': {
                            'overflow': 'hidden',
                            'display': '-webkit-box',
                            '-webkit-box-orient': 'vertical',
                            '-webkit-line-clamp': '2',
                        },
                    });
                }
            ],
        };
        
        // --- DARK MODE LOGIC ---
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    
    <!-- Custom Styles for 3D card flip -->
    <style>
        /* This is necessary for the card flip */
        .card-flipper {
            perspective: 1000px;
        }
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* Safari */
        }
        .card-back {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="font-inter bg-gray-100 dark:bg-gray-900">
    <!-- Main App Container -->
    <div id="app">
        <!-- This is where the app will be rendered by JavaScript -->
        <div classclass="flex items-center justify-center h-screen">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Loading CogniDeck...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
          getAuth,
          signInWithEmailAndPassword,
          createUserWithEmailAndPassword,
          signOut,
          onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
          getFirestore,
          collection,
          addDoc,
          doc,
          getDoc,
          getDocs,
          updateDoc,
          deleteDoc,
          query,
          where,
          onSnapshot,
          serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NEW: We are no longer using storage, but we need Functions
        import { 
            getFunctions, 
            httpsCallable 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";


        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE ---
        // This is the config you provided earlier.
        const firebaseConfig = {
          apiKey: "AIzaSyDaTxyHz5dr4aWCE4tAiql4jJ4ImrrJKQM",
          authDomain: "quizlet-type-app.firebaseapp.com",
          projectId: "quizlet-type-app",
          storageBucket: "quizlet-type-app.firebasestorage.app",
          messagingSenderId: "829739254487",
          appId: "1:829739254487:web:457ffc620af28c96f8a692"
        };
        
        // --- IMPORTANT: PASTE YOUR GEMINI API KEY HERE ---
        // This is the key you provided from Google AI Studio
        // WARNING: This is NOT secure for a public website!
        const GEMINI_API_KEY = "AIzaSyDxNcI0uaa1C6z6mc09lINO7rLcNe2xyig";


        // --- FIREBASE & APP INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app); // Initialize Functions
        setLogLevel('Debug'); // Use 'Debug' for detailed logs

        // --- GLOBAL APP STATE ---
        let globalUser = null;
        let globalAuthLoaded = false;
        let currentPage = 'auth';
        let currentSetId = null;
        let learnSettings = {}; // Store settings for learn mode

        const appContainer = document.getElementById('app');

        // --- NAVIGATION ---
        function navigate(page, setId = null) {
            currentPage = page;
            currentSetId = setId;
            render();
        }

        // --- RENDER FUNCTION ---
        // This is the main function that builds the UI
        function render() {
            if (!globalAuthLoaded) {
                appContainer.innerHTML = FullScreenLoader();
                return;
            }

            let pageHTML = '';
            
            // Show navbar on all pages except auth
            if (globalUser && currentPage !== 'auth') {
                pageHTML += NavbarHTML();
            }
            
            // Add main content with sidebars
            pageHTML += `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">`;
            pageHTML += `<div class="flex justify-center space-x-8">`;
            
            // Left Ad Sidebar (hidden on mobile)
            pageHTML += `
                <div class="hidden lg:block w-48 flex-shrink-0">
                    <div class="sticky top-24 w-48 h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <!-- PASTE AD SENSE CODE HERE -->
                        Ad Placeholder (160x600)
                    </div>
                </div>
            `;
            
            // Main Page Content
            pageHTML += `<div class="flex-grow min-w-0" style="max-width: 1024px;">`; // Main content container
            
            switch (currentPage) {
                case 'auth':
                    pageHTML += AuthPageHTML();
                    break;
                case 'dashboard':
                    pageHTML += DashboardPageHTML();
                    break;
                case 'search':
                    pageHTML += SearchPageHTML();
                    break;
                case 'upload':
                    pageHTML += UploadPageHTML();
                    break;
                case 'create':
                    pageHTML += SetEditorHTML();
                    break;
                case 'edit':
                    pageHTML += SetEditorHTML(currentSetId);
                    break;
                case 'study':
                    pageHTML += StudyPageHTML(currentSetId);
                    break;
                case 'quiz':
                    pageHTML += QuizPageHTML(currentSetId);
                    break;
                case 'learnSetup':
                    pageHTML += LearnSetupPageHTML(currentSetId);
                    break;
                case 'learn':
                    pageHTML += LearnPageHTML(currentSetId);
                    break;
                case 'about':
                    pageHTML += AboutPageHTML();
                    break;
                default:
                    pageHTML += DashboardPageHTML();
            }
            
            pageHTML += `</div>`; // End Main content container
            
            // Right Ad Sidebar (hidden on mobile)
            pageHTML += `
                <div class="hidden lg:block w-48 flex-shrink-0">
                    <div class="sticky top-24 w-48 h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <!-- PASTE AD SENSE CODE HERE -->
                        Ad Placeholder (160x600)
                    </div>
                </div>
            `;
            
            pageHTML += `</div>`; // End flex container
            pageHTML += `</div>`; // End max-w-7xl

            appContainer.innerHTML = pageHTML;

            // Attach event listeners after HTML is rendered
            attachAllListeners();
        }

        // --- EVENT LISTENER ATTACHMENT ---
        // This function finds all elements by ID and attaches their JS listeners
        function attachAllListeners() {
            // Dark Mode Toggle
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleDarkMode);
            }
            const mobileThemeToggleBtn = document.getElementById('mobile-theme-toggle');
            if (mobileThemeToggleBtn) {
                mobileThemeToggleBtn.addEventListener('click', toggleDarkMode);
            }
            
            // Mobile Menu
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }

            // Page-specific listeners
            switch (currentPage) {
                case 'auth':
                    attachAuthListeners();
                    break;
                case 'dashboard':
                    attachDashboardListeners();
                    break;
                case 'search':
                    attachSearchListeners();
                    break;
                case 'upload':
                    attachUploadListeners();
                    break;
                case 'create':
                    attachSetEditorListeners();
                    break;
                case 'edit':
                    attachSetEditorListeners(currentSetId);
                    break;
                case 'study':
                    attachStudyListeners(currentSetId);
                    break;
                case 'quiz':
                    attachQuizListeners(currentSetId);
                    break;
                case 'learnSetup':
                    attachLearnSetupListeners(currentSetId);
                    break;
                case 'learn':
                    attachLearnListeners(currentSetId);
                    break;
                // No listeners needed for About or Navbar
            }
            
            // Navbar listeners (need to be attached even if page is e.g. 'dashboard')
            if (globalUser) {
                attachNavbarListeners();
            }
        }

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            // Check if dark mode is currently enabled
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            // Re-render to update icons (sun/moon)
            render();
        }

        // --- ICONS (as functions returning strings) ---
        const IconHome = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>`;
        const IconSearch = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>`;
        const IconUpload = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>`;
        const IconPlus = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;
        const IconLogout = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>`;
        const IconTrash = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.502 0c.342.052.682.107 1.022.166m11.48 0c.342.052.682.107 1.022.166M4.772 5.79L4.772 5.79m14.456 0l-2.81-2.98m-11.48 0l2.81 2.98m0 0l-2.81 2.98m11.48 0l2.81 2.98" /></svg>`;
        const IconEdit = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`;
        const IconBack = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
        const IconFlip = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0 0v-4.992m0 0h-4.992" /></svg>`;
        const IconNext = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
        const IconPrev = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
        const IconPublic = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c.24 0 .477-.007.71-.021M12 21c-.24 0-.477-.007-.71-.021M12 15a3.75 3.75 0 003.75-3.75V8.25A3.75 3.75 0 0012 4.5v.001M12 15a3.75 3.75 0 01-3.75-3.75V8.25A3.75 3.75 0 0112 4.5v.001M12 15v.001M12 4.5v.001m0 0v.001m0 0h.001M12 15h.001M12 4.5h.001M12 3c-1.928 0-3.69.784-4.95 2.05S4.5 8.072 4.5 10v.75a8.217 8.217 0 004.22 7.029c.465.253.96.442 1.48.59M12 3c1.928 0 3.69.784 4.95 2.05S19.5 8.072 19.5 10v.75a8.217 8.217 0 01-4.22 7.029c-.465.253-.96.442-1.48.59M12 3v.001" /></svg>`;
        const IconPrivate = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>`;
        const IconCheck = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
        const IconAI = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" class="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 21.75l-.648-1.188a2.25 2.25 0 00-1.579-1.579L12.75 18.25l1.188-.648a2.25 2.25 0 001.579-1.579L16.25 15l.648 1.188a2.25 2.25 0 001.579 1.579L19.75 18.25l-1.188.648a2.25 2.25 0 00-1.579 1.579z" /></svg>`;
        const IconBook = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.105 0 4.059.983 5.25 2.688.097.132.2.263.3.391.098.127.203.25.308.371l.01.01.006.007.002.002.002.002.006.007.01.01c.098.12.206.24.314.368.106.126.21.25.312.37.112.128.22.25.324.368.216.239.423.47.625.69.106.115.207.224.306.33a8.952 8.952 0 005.25-2.688c.938-.332 1.948-.512 3-.512h.001v-14.25c-.938.332-1.948.512-3 .512a8.967 8.967 0 00-6-2.292z" /></svg>`;
        const IconQuiz = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25c.092-.004.186-.006.281-.006H14.25l4.5 4.5v1.875M10.125 2.25L10.5 6h4.125L18.75 2.625M10.125 6.375L10.5 10.5h4.125L18.75 6.875M10.125 10.875L10.5 15h4.125L18.75 11.375M10.125 15.375L10.5 19.5h4.125L18.75 15.875" /></svg>`;
        const IconLearn = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 000 7.706c0 1.518.81 2.818 2.12 3.664a4.5 4.5 0 006.016-1.583A6.002 6.002 0 0014.25 18.001c.22.82.78 1.518 1.62 1.984A4.5 4.5 0 0021.75 18c.21-.82.4-1.67.4-2.553a60.437 60.437 0 000-7.706c0-1.518-.81-2.818-2.12-3.664a4.5 4.5 0 00-6.016 1.583A6.002 6.002 0 009.75 6.001c-.22-.82-.78-1.518-1.62-1.984A4.5 4.5 0 002.25 6c-.21.82-.4 1.67-.4 2.553z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9c0 .052.002.105.005.157M15.75 9c0 1.203-.404 2.306-1.09 3.192M15.75 9c.39 1.34.409 2.766.052 4.105M15.75 9a4.498 4.498 0 00-4.498-4.498M15.75 9C13.56 9 12 7.44 12 5.25" /></svg>`;
        const IconInfo = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`;
        const IconSun = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 12a4.5 4.5 0 100 9 4.5 4.5 0 000-9z" /></svg>`;
        const IconMoon = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;

        // --- COMPONENTS (as functions returning HTML strings) ---

        function FullScreenLoader() {
            return `
                <div class="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
                  <div class="flex flex-col items-center">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Loading CogniDeck...</p>
                  </div>
                </div>
            `;
        }

        function NavbarHTML() {
            const isDark = document.documentElement.classList.contains('dark');
            
            const NavButton = (page, icon, label) => `
                <button
                    id="nav-${page}"
                    class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium ${
                    currentPage === page
                      ? 'bg-blue-600 text-white'
                      : 'text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-800 hover:text-blue-700 dark:hover:text-blue-400'
                  }"
                >
                  ${icon}
                  <span>${label}</span>
                </button>
            `;
            
            const MobileNavButton = (page, icon, label) => `
                <button
                    id="mobile-nav-${page}"
                    class="flex items-center w-full px-4 py-3 text-base font-medium rounded-md ${
                    currentPage === page
                      ? 'bg-blue-100 dark:bg-gray-800 text-blue-700 dark:text-blue-400'
                      : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
                  }"
                >
                  ${icon}
                  <span class="ml-3">${label}</span>
                </button>
            `;

            return `
                <nav class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md dark:shadow-gray-700 z-50">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                      
                      <!-- Logo -->
                      <div class="flex-shrink-0 flex items-center cursor-pointer" id="nav-logo">
                        <span class="text-2xl font-bold text-blue-600 dark:text-blue-500">CogniDeck</span>
                      </div>

                      <!-- Desktop Nav -->
                      <div class="hidden md:flex md:items-center md:space-x-4">
                        ${NavButton('dashboard', IconHome(), 'Home')}
                        ${NavButton('search', IconSearch(), 'Search')}
                        ${NavButton('upload', IconUpload(), 'Import')}
                        ${NavButton('about', IconInfo(), 'About')}
                        <button
                          id="nav-create"
                          class="ml-4 flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                          ${IconPlus()}
                          <span class="ml-2">Create Set</span>
                        </button>
                      </div>

                      <!-- User Menu (Desktop) -->
                      <div class="hidden md:flex items-center space-x-3">
                         <button
                           id="theme-toggle"
                           class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                           title="Toggle dark mode"
                         >
                           ${isDark ? IconSun() : IconMoon()}
                         </button>
                         <span class="text-sm text-gray-600 dark:text-gray-300 hidden lg:block">${globalUser.email}</span>
                         <button
                          id="nav-signout"
                          class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                          title="Sign Out"
                        >
                          ${IconLogout()}
                        </button>
                      </div>
                      
                      <!-- Mobile Menu Button -->
                      <div class="md:hidden flex items-center">
                        <button
                           id="mobile-theme-toggle"
                           class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                           title="Toggle dark mode"
                         >
                           ${isDark ? IconSun() : IconMoon()}
                         </button>
                        <button
                          id="mobile-menu-btn"
                          class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700"
                          aria-controls="mobile-menu"
                          aria-expanded="false"
                        >
                          <span class="sr-only">Open main menu</span>
                          <svg id="mobile-menu-icon-open" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                          </svg>
                          <svg id="mobile-menu-icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>

                    </div>
                  </div>

                  <!-- Mobile Menu -->
                  <div class="hidden md:hidden" id="mobile-menu">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                      ${MobileNavButton('dashboard', IconHome(), 'Home')}
                      ${MobileNavButton('search', IconSearch(), 'Search')}
                      ${MobileNavButton('upload', IconUpload(), 'Import')}
                      ${MobileNavButton('create', IconPlus(), 'Create Set')}
                      ${MobileNavButton('about', IconInfo(), 'About')}
                    </div>
                    <div class="pt-4 pb-3 border-t border-gray-200 dark:border-gray-700">
                      <div class="flex items-center px-5">
                        <div class="ml-3">
                          <div class="text-base font-medium text-gray-800 dark:text-gray-200">${globalUser.email}</div>
                        </div>
                      </div>
                      <div class="mt-3 px-2 space-y-1">
                        <button
                          id="mobile-nav-signout"
                          class="flex items-center w-full px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"
                        >
                          ${IconLogout()}
                          <span class="ml-3">Sign out</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </nav>
            `;
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const iconOpen = document.getElementById('mobile-menu-icon-open');
            const iconClose = document.getElementById('mobile-menu-icon-close');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                iconOpen.classList.add('hidden');
                iconClose.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
                iconOpen.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        }
        
        function attachNavbarListeners() {
            // Desktop listeners
            document.getElementById('nav-logo').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-search').addEventListener('click', () => navigate('search'));
            document.getElementById('nav-upload').addEventListener('click', () => navigate('upload'));
            document.getElementById('nav-about').addEventListener('click', () => navigate('about'));
            document.getElementById('nav-create').addEventListener('click', () => navigate('create'));
            document.getElementById('nav-signout').addEventListener('click', handleSignOut);
            
            // Mobile listeners
            document.getElementById('mobile-nav-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('mobile-nav-search').addEventListener('click', () => navigate('search'));
            document.getElementById('mobile-nav-upload').addEventListener('click', () => navigate('upload'));
            document.getElementById('mobile-nav-create').addEventListener('click', () => navigate('create'));
            document.getElementById('mobile-nav-about').addEventListener('click', () => navigate('about'));
            document.getElementById('mobile-nav-signout').addEventListener('click', handleSignOut);
        }
        
        async function handleSignOut() {
            try {
              await signOut(auth);
              // Auth listener in App.js will handle success
            } catch (error) {
              console.error("Error signing out:", error);
              alert("Error signing out: " + error.message);
            }
        }

        function AuthPageHTML() {
            // This page is special, it's not wrapped in the ad container
            return `
                <div class="flex items-center justify-center min-h-screen -mt-16 bg-gray-100 dark:bg-gray-900">
                  <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                    <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">
                      Welcome to <span class="text-blue-600 dark:text-blue-500">CogniDeck</span>
                    </h2>
                    
                    <form class="space-y-6" id="auth-form">
                      <div>
                        <label
                          for="email"
                          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                        >
                          Email address
                        </label>
                        <input
                          id="email"
                          name="email"
                          type="email"
                          autoComplete="email"
                          required
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        />
                      </div>
                      <div>
                        <label
                          for="password"
                          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                        >
                          Password
                        </label>
                        <input
                          id="password"
                          name="password"
                          type="password"
                          autoComplete="current-password"
                          required
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        />
                      </div>

                      <p id="auth-error" class="text-sm text-red-600 hidden"></p>

                      <button
                        type="submit"
                        id="auth-submit-btn"
                        class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                      >
                        Log In
                      </button>
                    </form>

                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                      <span id="auth-toggle-text">Don't have an account?</span>
                      <button
                        id="auth-toggle-btn"
                        class="ml-1 font-medium text-blue-600 dark:text-blue-500 hover:text-blue-500 dark:hover:text-blue-400"
                      >
                        Sign Up
                      </button>
                    </p>
                  </div>
                </div>
            `;
        }

        function attachAuthListeners() {
            const authForm = document.getElementById('auth-form');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authToggleBtn = document.getElementById('auth-toggle-btn');
            const authToggleText = document.getElementById('auth-toggle-text');
            const authError = document.getElementById('auth-error');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            let isLogin = true;

            authToggleBtn.addEventListener('click', () => {
                isLogin = !isLogin;
                if (isLogin) {
                    authSubmitBtn.textContent = 'Log In';
                    authToggleText.textContent = "Don't have an account?";
                    authToggleBtn.textContent = 'Sign Up';
                } else {
                    authSubmitBtn.textContent = 'Sign Up';
                    authToggleText.textContent = 'Already have an account?';
                    authToggleBtn.textContent = 'Log In';
                }
                authError.classList.add('hidden');
                authError.textContent = '';
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;

                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = isLogin ? 'Logging in...' : 'Signing up...';
                authError.classList.add('hidden');

                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    // Auth listener in App.js will handle success
                } catch (err) {
                    authError.textContent = err.message;
                    authError.classList.remove('hidden');
                    authSubmitBtn.disabled = false;
                    authSubmitBtn.textContent = isLogin ? 'Log In' : 'Sign Up';
                }
            });
        }
        
        function AboutPageHTML() {
            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-2xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 text-center">About CogniDeck</h1>
                    
                    <div class="space-y-6 text-gray-700 dark:text-gray-300">
                        <p>
                            <strong>CogniDeck</strong> is a free, AI-powered flashcard application built to make studying smarter, faster, and more accessible for everyone. It's built as a single, lightweight HTML file that connects to a powerful and free backend on Firebase.
                        </p>
                        
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Core Features</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Create & Manage Sets:</strong> Easily create, edit, and delete your own study sets.</li>
                                <li><strong>Multiple Study Modes:</strong> Study with classic 3D Flashcards, a multiple-choice Quiz, or the smart "Learn" mode.</li>
                                <li><strong>AI Import:</strong> Upload a `.txt` or `.pdf` file and let Google's AI automatically generate flashcards for you.</li>
                                <li><strong>Search:</strong> Discover public sets created by other users.</li>
                                <li><strong>Dark Mode:</strong> Study any time, day or night, with a comfortable dark theme.</li>
                            </ul>
                        </div>
                        
                        <div class="p-4 bg-blue-50 dark:bg-gray-700 rounded-lg text-center">
                            <h2 class="text-xl font-semibold text-blue-800 dark:text-blue-300 mb-3">About the Creator</h2>
                            <p class="text-gray-700 dark:text-gray-300">
                                Hi, I'm <strong>Andrew Stevenson</strong>, a 14-year-old student with a passion for coding.
                            </p>
                            <p class="mt-2 text-gray-700 dark:text-gray-300">
                                I built CogniDeck from the ground up because I wanted to create a powerful study tool that was 100% free for students like me. This whole project was an amazing adventure in learning how to use technologies like Firebase, Google's Gemini AI, and Tailwind CSS to build something real. I hope you find it helpful for your classes!
                            </p>
                        </div>
                        
                        <p>
                            This project demonstrates how modern web technologies (HTML, JavaScript, and Tailwind CSS) can be combined with powerful cloud services (Firebase and Google AI) to create a full-featured, responsive application without a complex server setup.
                        </p>
                    </div>
                </div>
            `;
        }

        // --- DASHBOARD PAGE ---
        function DashboardPageHTML() {
            return `
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Your Study Sets</h1>
                  <div id="dashboard-set-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-700 dark:text-gray-300">Loading your sets...</p>
                  </div>
                </div>
            `;
        }

        function attachDashboardListeners() {
            const setsCollection = collection(db, "studySets");
            const q = query(setsCollection, where("ownerId", "==", globalUser.uid));
            
            const setListContainer = document.getElementById('dashboard-set-list');

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    setListContainer.innerHTML = `
                        <div class="col-span-full text-center p-12 bg-white dark:bg-gray-800 rounded-lg shadow">
                          <h3 class="text-xl font-medium text-gray-800 dark:text-white">No sets yet!</h3>
                          <p class="text-gray-600 dark:text-gray-400 mt-2 mb-4">Create a set manually or import a document to get started.</p>
                          <button
                            id="dashboard-create-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                          >
                            ${IconPlus()}
                            <span class="ml-2">Create New Set</span>
                          </button>
                        </div>
                    `;
                    document.getElementById('dashboard-create-btn').addEventListener('click', () => navigate('create'));
                    return;
                }

                let setsHTML = '';
                querySnapshot.forEach((doc) => {
                    setsHTML += SetCardHTML(doc.id, doc.data());
                });
                setListContainer.innerHTML = setsHTML;
                
                // Add listeners for all the new cards
                querySnapshot.forEach((doc) => {
                    document.getElementById(`study-${doc.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (doc.data().cards && doc.data().cards.length > 0) {
                            navigate('study', doc.id);
                        } else {
                            alert("This set has no cards! Add cards to study.");
                            navigate('edit', doc.id);
                        }
                    });
                    document.getElementById(`edit-${doc.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        navigate('edit', doc.id);
                    });
                    document.getElementById(`quiz-${doc.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (doc.data().cards && doc.data().cards.length >= 4) {
                            navigate('quiz', doc.id);
                        } else {
                            alert("You need at least 4 cards in a set to start a quiz.");
                        }
                    });
                    document.getElementById(`learn-${doc.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (doc.data().cards && doc.data().cards.length > 0) {
                            navigate('learnSetup', doc.id);
                        } else {
                            alert("This set has no cards! Add cards to study.");
                            navigate('edit', doc.id);
                        }
                    });
                    document.getElementById(`card-${doc.id}`).addEventListener('click', () => {
                        navigate('edit', doc.id);
                    });
                });

            }, (err) => {
                console.error("Error fetching sets:", err);
                setListContainer.innerHTML = `<p class="text-red-600">Failed to load your study sets. Please try again later.</p>`;
            });
        }
        
        function SetCardHTML(id, set, isPublicSearch = false) {
            const cardCount = set.cards ? set.cards.length : 0;
            const ownerEmail = set.ownerEmail || null;

            return `
                <div 
                  id="card-${id}"
                  class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl cursor-pointer flex flex-col justify-between"
                >
                  <div class="p-6">
                    <div class="flex justify-between items-start">
                      <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">${set.title}</h3>
                       ${set.isPublic ? `
                        <div class="flex items-center text-xs text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900 px-2 py-1 rounded-full">
                          ${IconPublic()}
                          <span class="ml-1">Public</span>
                        </div>
                      ` : (
                        !isPublicSearch ? `
                          <div class="flex items-center text-xs text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 px-2 py-1 rounded-full">
                            ${IconPrivate()}
                            <span class="ml-1">Private</span>
                          </div>
                        ` : ''
                      )}
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-2">${set.description || "No description."}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                      ${cardCount} ${cardCount === 1 ? 'card' : 'cards'}
                    </p>
                    ${isPublicSearch && ownerEmail ? `
                      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Created by: ${ownerEmail}
                      </p>
                    ` : ''}
                  </div>
                  
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 flex flex-wrap justify-end gap-2">
                    ${!isPublicSearch ? `
                      <button
                        id="edit-${id}"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                      >
                        ${IconEdit()}
                        <span class="ml-2">Edit</span>
                      </button>
                    ` : ''}
                    
                    <button
                        id="learn-${id}"
                        disabled=${cardCount === 0}
                        class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        ${IconLearn()}
                        <span class="ml-2">Learn</span>
                    </button>
                    
                    <button
                        id="quiz-${id}"
                        disabled=${cardCount < 4}
                        class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 ${cardCount < 4 ? 'opacity-50 cursor-not-allowed' : ''}"
                      >
                        ${IconQuiz()}
                        <span class="ml-2">Quiz</span>
                    </button>
                    
                    <button
                      id="study-${id}"
                      disabled=${cardCount === 0}
                      class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      ${IconBook()}
                      <span class="ml-2">Study</span>
                    </button>
                  </div>
                </div>
            `;
        }
        
        // --- SEARCH PAGE ---
        function SearchPageHTML() {
            return `
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Search Public Sets</h1>
                  
                  <div class="mb-6">
                    <input
                      type="text"
                      id="search-input"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                      placeholder="Search by title or description..."
                    />
                  </div>
            
                  <div id="search-results-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-700 dark:text-gray-300">Loading public sets...</p>
                  </div>
                </div>
            `;
        }
        
        function attachSearchListeners() {
            const searchInput = document.getElementById('search-input');
            const resultsList = document.getElementById('search-results-list');
            let allPublicSets = [];
            
            // Fetch all public sets once
            const setsCollection = collection(db, "studySets");
            const q = query(setsCollection, where("isPublic", "==", true));

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                allPublicSets = [];
                querySnapshot.forEach((doc) => {
                    allPublicSets.push({ id: doc.id, ...doc.data() });
                });
                renderSearchResults(allPublicSets);
            }, (err) => {
                console.error("Error fetching public sets:", err);
                resultsList.innerHTML = `<p class="text-red-600">Failed to load public sets.</p>`;
            });
            
            // Add search input listener
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    renderSearchResults(allPublicSets);
                    return;
                }
                const filteredSets = allPublicSets.filter(set => 
                    set.title.toLowerCase().includes(searchTerm) ||
                    (set.description && set.description.toLowerCase().includes(searchTerm))
                );
                renderSearchResults(filteredSets, searchTerm);
            });

            // Helper to render results
            function renderSearchResults(sets, searchTerm = null) {
                if (sets.length === 0) {
                    resultsList.innerHTML = `<p class="text-gray-600 dark:text-gray-400">
                        ${searchTerm ? 'No sets found matching your search.' : 'No public sets available.'}
                    </p>`;
                    return;
                }
                
                let setsHTML = '';
                sets.forEach(set => {
                    setsHTML += SetCardHTML(set.id, set, true);
                });
                resultsList.innerHTML = setsHTML;
                
                // Add listeners for all the new cards
                sets.forEach(set => {
                    document.getElementById(`study-${set.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (set.cards && set.cards.length > 0) {
                            navigate('study', set.id);
                        } else {
                            alert("This set has no cards!");
                        }
                    });
                    document.getElementById(`quiz-${set.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (set.cards && set.cards.length >= 4) {
                            navigate('quiz', set.id);
                        } else {
                            alert("You need at least 4 cards in a set to start a quiz.");
                        }
                    });
                    document.getElementById(`learn-${set.id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (set.cards && set.cards.length > 0) {
                            navigate('learnSetup', set.id);
                        } else {
                            alert("This set has no cards!");
                        }
                    });
                    document.getElementById(`card-${set.id}`).addEventListener('click', () => {
                        if (set.cards && set.cards.length > 0) {
                            navigate('study', set.id);
                        } else {
                            alert("This set has no cards!");
                        }
                    });
                });
            }
        }
        
        // --- UPLOAD PAGE ---
        function UploadPageHTML() {
            return `
                <div class="max-w-2xl mx-auto">
                  <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                    ${IconAI()}
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mt-4 mb-4">Import & Auto-Create</h1>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                      Upload a `.txt` or `.pdf` file and our AI will
                      automatically create flashcards for you.
                    </p>
            
                    <div class="p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                      <label 
                        for="file-upload" 
                        class="cursor-pointer inline-flex items-center px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"
                      >
                        ${IconUpload()}
                        <span class="ml-2" id="file-upload-label">Select a file</span>
                      </label>
                      <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".pdf,.txt" />
                      
                      <p id="file-name" class="mt-4 text-sm text-gray-600 dark:text-gray-400 hidden"></p>
                    </div>
                    
                    <!-- Progress bar -->
                    <div id="upload-progress-bar" class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-4 hidden">
                      <div id="upload-progress-inner" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    
                    <button
                      id="upload-btn"
                      disabled
                      class="w-full mt-8 px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                    >
                      Upload & Generate
                    </button>
                    
                    <p id="upload-message" class="mt-4 text-sm text-green-600 dark:text-green-400"></p>
                  </div>
                </div>
            `;
        }
        
        function attachUploadListeners() {
            const fileInput = document.getElementById('file-upload');
            const fileLabel = document.getElementById('file-upload-label');
            const fileName = document.getElementById('file-name');
            const uploadBtn = document.getElementById('upload-btn');
            const message = document.getElementById('upload-message');
            const progressBar = document.getElementById('upload-progress-bar');
            const progressInner = document.getElementById('upload-progress-inner');
            
            let selectedFile = null;

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    fileName.textContent = `Selected: ${selectedFile.name}`;
                    fileName.classList.remove('hidden');
                    fileLabel.textContent = 'Change file';
                    uploadBtn.disabled = false;
                    message.textContent = '';
                }
            });

            uploadBtn.addEventListener('click', handleUpload);

            async function handleUpload() {
                if (!selectedFile) {
                    message.textContent = 'Please select a file first.';
                    message.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    return;
                }
                
                if (!globalUser) {
                    message.textContent = 'You must be logged in to upload a file.';
                    message.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    return;
                }

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Processing...';
                message.textContent = 'Reading file...';
                message.className = 'mt-4 text-sm text-blue-600 dark:text-blue-400';
                progressBar.classList.add('hidden'); // We won't show progress bar for reading
                
                try {
                    let extractedText = "";
                    
                    // 1. Read the file in the browser
                    if (selectedFile.type === "application/pdf") {
                        const fileReader = new FileReader();
                        fileReader.onload = async (e) => {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                extractedText += textContent.items.map(item => item.str).join(' ');
                            }
                            callGemini(extractedText, selectedFile.name);
                        };
                        fileReader.readAsArrayBuffer(selectedFile);
                    } else {
                        const fileReader = new FileReader();
                        fileReader.onload = (e) => {
                            extractedText = e.target.result;
                            callGemini(extractedText, selectedFile.name);
                        };
                        fileReader.readAsText(selectedFile);
                    }
                } catch (err) {
                    console.error("File read error:", err);
                    message.textContent = `Error reading file: ${err.message}`;
                    message.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload & Generate';
                }
            }
            
            async function callGemini(text, sourceFileName) {
                if (text.length < 50) {
                    message.textContent = 'File does not contain enough text to process.';
                    message.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload & Generate';
                    return;
                }
                
                message.textContent = 'File read. Asking AI to create flashcards... (this may take a moment)';
                uploadBtn.textContent = 'Generating...';

                const prompt = `
                    You are an expert study assistant.
                    Analyze the following text and extract the most important key terms and their definitions.
                    Return your answer as a valid JSON array of objects, where each object has a "term" and "definition" key.
                    
                    Example: [{"term": "Mitochondria", "definition": "The powerhouse of the cell."}]
                    
                    If you cannot find any good terms, return an empty array [].
                    Do not return more than 50 cards.
                    
                    Text to analyze:
                    ---
                    ${text.substring(0, 100000)}
                    ---
                `;
                
                try {
                    // 2. Call Google Gemini API
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`AI API error: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const aiText = result.candidates[0].content.parts[0].text;
                    
                    // Clean the response to make sure it's valid JSON
                    let jsonText = aiText.trim().replace(/^```json|```$/g, "").trim();
                    
                    const cards = JSON.parse(jsonText);

                    if (cards.length === 0) {
                        message.textContent = 'The AI could not find any flashcards in that text.';
                        message.className = 'mt-4 text-sm text-yellow-600 dark:text-yellow-400';
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload & Generate';
                        return;
                    }
                    
                    // 3. Save the new set to Firestore
                    message.textContent = 'AI complete! Saving new set...';
                    const newSet = {
                      title: `AI Set: ${sourceFileName}`,
                      description: `Generated from file: ${sourceFileName}`,
                      ownerId: globalUser.uid,
                      ownerEmail: globalUser.email,
                      isPublic: false,
                      cards: cards,
                      createdAt: serverTimestamp(),
                      updatedAt: serverTimestamp(),
                    };
                    
                    const docRef = await addDoc(collection(db, "studySets"), newSet);
                    console.log(`Successfully created new study set with ID: ${docRef.id}`);
                    
                    message.textContent = 'Success! Your new set is on the dashboard.';
                    message.className = 'mt-4 text-sm text-green-600 dark:text-green-400';
                    
                    // Reset form
                    selectedFile = null;
                    fileName.classList.add('hidden');
                    fileLabel.textContent = 'Select a file';
                    fileInput.value = ''; // Clear file input
                    
                    setTimeout(() => {
                        navigate('dashboard');
                    }, 2000);
                    
                } catch (err) {
                    console.error("Error in AI Function:", err);
                    message.textContent = `An error occurred: ${err.message}`;
                    message.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload & Generate';
                }
            }
        }
        
        
        // --- SET EDITOR PAGE ---
        let editorCards = [{ term: '', definition: '' }];
        
        function SetEditorHTML(setId = null) {
            const isEditing = setId !== null;
            return `
                <div class="max-w-4xl mx-auto">
                  <button id="editor-back-btn" class="flex items-center text-blue-600 dark:text-blue-500 hover:underline mb-4">
                    ${IconBack()}
                    <span class="ml-1">Back to Dashboard</span>
                  </button>
                  
                  <form id="editor-form" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">${isEditing ? 'Edit Study Set' : 'Create New Study Set'}</h1>
            
                    <div id="editor-loading-state" class="hidden"><p class="text-gray-700 dark:text-gray-300">Loading set editor...</p></div>
                    <div id="editor-error-state" class="hidden"><p class="text-red-600"></p></div>
                    
                    <div id="editor-content" class="space-y-6">
                      <!-- Set Details -->
                      <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                        <input
                          type="text"
                          id="title"
                          required
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          placeholder="e.g. Biology - Chapter 1"
                        />
                      </div>
                      <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                        <textarea
                          id="description"
                          rows="3"
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          placeholder="A quick summary of what this set covers"
                        ></textarea>
                      </div>
                      
                      <!-- Privacy Toggle -->
                      <div class="flex items-center justify-between">
                        <span class="flex-grow flex flex-col">
                          <span class="text-sm font-medium text-gray-900 dark:text-white">Visibility</span>
                          <span id="visibility-text" class="text-sm text-gray-500 dark:text-gray-400">Only visible to you.</span>
                        </span>
                        <button
                          type="button"
                          id="visibility-toggle"
                          class="bg-gray-200 dark:bg-gray-600 relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
                        >
                          <span class="sr-only">Toggle Visibility</span>
                          <span
                            id="visibility-knob"
                            class="translate-x-1 inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
                          />
                        </button>
                      </div>
            
                      <!-- Cards Section -->
                      <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Flashcards</h2>
                        <div id="cards-container" class="space-y-4">
                          <!-- Cards will be rendered here by JS -->
                        </div>
                        
                        <button
                          type="button"
                          id="add-card-btn"
                          class="mt-4 inline-flex items-center px-4 py-2 border border-dashed border-gray-400 dark:border-gray-500 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                        >
                          ${IconPlus()}
                          <span class="ml-2">Add Card</span>
                        </button>
                      </div>
                    </div>
            
                    <p id="editor-form-error" class="text-red-600 mt-4 hidden"></p>
                    
                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                      <div>
                        ${isEditing ? `
                          <button
                            type="button"
                            id="delete-set-btn"
                            class="text-sm font-medium text-red-600 hover:text-red-800 dark:hover:text-red-400"
                          >
                            Delete Set
                          </button>
                        ` : `<div></div>`}
                      </div>
                      <button
                        type="submit"
                        id="editor-submit-btn"
                        class="px-6 py-2 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                      >
                        ${isEditing ? 'Update Set' : 'Create Set'}
                      </button>
                    </div>
                  </form>
                  
                  <!-- Delete Confirmation Modal -->
                  <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                      <h3 class="text-lg font-medium text-gray-900 dark:text-white">Delete Study Set?</h3>
                      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Are you sure? This action cannot be undone.</p>
                      <div class="mt-6 flex justify-end space-x-3">
                        <button
                          type="button"
                          id="delete-cancel-btn"
                          class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"
                        >
                          Cancel
                        </button>
                        <button
                          type="button"
                          id="delete-confirm-btn"
                          class="px-4 py-2 bg-red-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
            `;
        }
        
        function renderEditorCards() {
            const container = document.getElementById('cards-container');
            if (!container) return;
            
            container.innerHTML = editorCards.map((card, index) => `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Term</label>
                    <input
                      type="text"
                      data-index="${index}"
                      data-field="term"
                      value="${card.term}"
                      class="card-input w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      placeholder="Term"
                    />
                  </div>
                  <div class="flex">
                    <div class="flex-grow">
                      <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Definition</label>
                      <input
                        type="text"
                        data-index="${index}"
                        data-field="definition"
                        value="${card.definition}"
                        class="card-input w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Definition"
                      />
                    </div>
                    <button
                      type="button"
                      data-index="${index}"
                      class="remove-card-btn ml-2 mt-6 p-2 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 rounded-full h-10 w-10 flex items-center justify-center"
                      title="Delete card"
                    >
                      ${IconTrash()}
                    </button>
                  </div>
                </div>
            `).join('');
            
            // Re-attach listeners for card inputs and remove buttons
            document.querySelectorAll('.card-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    editorCards[index][field] = e.target.value;
                });
            });
            
            document.querySelectorAll('.remove-card-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (editorCards.length <= 1) {
                        alert("You must have at least one card.");
                        return;
                    }
                    const index = parseInt(e.currentTarget.dataset.index);
                    editorCards.splice(index, 1);
                    renderEditorCards(); // Re-render the card list
                });
            });
        }
        
        async function attachSetEditorListeners(setId = null) {
            const isEditing = setId !== null;
            let isPublic = false;

            // Get all elements
            const backBtn = document.getElementById('editor-back-btn');
            const form = document.getElementById('editor-form');
            const loadingState = document.getElementById('editor-loading-state');
            const errorState = document.getElementById('editor-error-state');
            const content = document.getElementById('editor-content');
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const visibilityText = document.getElementById('visibility-text');
            const visibilityToggle = document.getElementById('visibility-toggle');
            const visibilityKnob = document.getElementById('visibility-knob');
            const addCardBtn = document.getElementById('add-card-btn');
            const formError = document.getElementById('editor-form-error');
            const submitBtn = document.getElementById('editor-submit-btn');
            
            backBtn.addEventListener('click', () => navigate('dashboard'));
            
            // Visibility Toggle
            visibilityToggle.addEventListener('click', () => {
                isPublic = !isPublic;
                if (isPublic) {
                    visibilityToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    visibilityToggle.classList.add('bg-blue-600', 'dark:bg-blue-500');
                    visibilityKnob.classList.remove('translate-x-1');
                    visibilityKnob.classList.add('translate-x-6');
                    visibilityText.textContent = 'Visible to everyone.';
                } else {
                    visibilityToggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
                    visibilityToggle.classList.remove('bg-blue-600', 'dark:bg-blue-500');
                    visibilityKnob.classList.add('translate-x-1');
                    visibilityKnob.classList.remove('translate-x-6');
                    visibilityText.textContent = 'Only visible to you.';
                }
            });

            // Add Card
            addCardBtn.addEventListener('click', () => {
                editorCards.push({ term: '', definition: '' });
                renderEditorCards();
            });

            // Form Submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                formError.classList.add('hidden');

                const finalCards = editorCards.filter(card => card.term.trim() !== '' && card.definition.trim() !== '');

                if (finalCards.length === 0) {
                    formError.textContent = "You must have at least one valid card with a term and definition.";
                    formError.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEditing ? 'Update Set' : 'Create Set';
                    return;
                }

                const setData = {
                    title: titleInput.value.trim(),
                    description: descriptionInput.value.trim(),
                    isPublic,
                    ownerId: globalUser.uid,
                    ownerEmail: globalUser.email,
                    cards: finalCards,
                    updatedAt: serverTimestamp(),
                };

                try {
                    if (isEditing) {
                        const docRef = doc(db, "studySets", setId);
                        await updateDoc(docRef, setData);
                    } else {
                        setData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "studySets"), setData);
                    }
                    navigate('dashboard');
                } catch (err) {
                    console.error("Error saving set:", err);
                    formError.textContent = "Failed to save set: " + err.message;
                    formError.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEditing ? 'Update Set' : 'Create Set';
                }
            });

            // Delete Button (if editing)
            if (isEditing) {
                const deleteSetBtn = document.getElementById('delete-set-btn');
                const deleteModal = document.getElementById('delete-confirm-modal');
                const deleteCancelBtn = document.getElementById('delete-cancel-btn');
                const deleteConfirmBtn = document.getElementById('delete-confirm-btn');

                deleteSetBtn.addEventListener('click', () => deleteModal.classList.remove('hidden'));
                deleteCancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
                
                deleteConfirmBtn.addEventListener('click', async () => {
                    deleteConfirmBtn.disabled = true;
                    deleteConfirmBtn.textContent = 'Deleting...';
                    try {
                        const docRef = doc(db, "studySets", setId);
                        await deleteDoc(docRef);
                        navigate('dashboard');
                    } catch (err) {
                        console.error("Error deleting set:", err);
                        formError.textContent = "Failed to delete set: " + err.message;
                        formError.classList.remove('hidden');
                        deleteConfirmBtn.disabled = false;
                        deleteConfirmBtn.textContent = 'Delete';
                        deleteModal.classList.add('hidden');
                    }
                });
            }

            // Load data if editing
            if (isEditing) {
                loadingState.classList.remove('hidden');
                content.classList.add('hidden');
                
                try {
                    const docRef = doc(db, "studySets", setId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.ownerId !== globalUser.uid) {
                            throw new Error("You don't have permission to edit this set.");
                        }
                        titleInput.value = data.title;
                        descriptionInput.value = data.description || '';
                        if (data.isPublic) {
                            visibilityToggle.click(); // Simulate click to set state
                        }
                        editorCards = data.cards.length > 0 ? data.cards : [{ term: '', definition: '' }];
                    } else {
                        throw new Error("Study set not found.");
                    }
                } catch (err) {
                    console.error("Error fetching set:", err);
                    errorState.classList.remove('hidden');
                    errorState.querySelector('p').textContent = err.message;
                    loadingState.classList.add('hidden');
                } finally {
                    loadingState.classList.add('hidden');
                    content.classList.remove('hidden');
                    renderEditorCards();
                }
            } else {
                // It's a new set, just render the initial empty card
                editorCards = [{ term: '', definition: '' }];
                content.classList.remove('hidden');
                renderEditorCards();
            }
        }
        
        // --- STUDY PAGE ---
        function StudyPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto" id="study-page-container">
                  <p class="text-gray-700 dark:text-gray-300">Loading study set...</p>
                </div>
                
                <!-- Completion Modal -->
                <div id="study-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                  <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Set Complete!</h3>
                    <p class="mt-4 text-lg text-gray-600 dark:text-gray-400" id="study-complete-message"></p>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                      <button
                        type="button"
                        id="study-restart-btn"
                        class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                      >
                        Study Again
                      </button>
                      <button
                        type="button"
                        id="study-back-btn"
                        class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"
                      >
                        Back to Dashboard
                      </button>
                    </div>
                  </div>
                </div>
            `;
        }
        
        async function attachStudyListeners(setId) {
            const container = document.getElementById('study-page-container');
            let set = null;
            let currentIndex = 0;
            let isFlipped = false;
            let knownCards = new Set();
            let showComplete = false;

            try {
                const docRef = doc(db, "studySets", setId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    set = { id: docSnap.id, ...docSnap.data() };
                    renderStudyUI();
                } else {
                    throw new Error("Study set not found.");
                }
            } catch (err) {
                console.error("Error fetching set:", err);
                container.innerHTML = `<p class="text-red-600">${err.message}</p>
                    <button id="back-to-dash" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md">Back to Dashboard</button>`;
                document.getElementById('back-to-dash').addEventListener('click', () => navigate('dashboard'));
            }
            
            function renderStudyUI() {
                if (showComplete) {
                    const modal = document.getElementById('study-complete-modal');
                    document.getElementById('study-complete-message').textContent = `You've marked all ${set.cards.length} cards as known.`;
                    modal.classList.remove('hidden');
                    
                    document.getElementById('study-restart-btn').addEventListener('click', restart);
                    document.getElementById('study-back-btn').addEventListener('click', () => navigate('dashboard'));
                    return;
                }
                
                const currentCard = set.cards[currentIndex];
                const isKnown = knownCards.has(currentCard.term);
                const progressPercent = (knownCards.size / set.cards.length) * 100;

                container.innerHTML = `
                    <button id="study-page-back" class="flex items-center text-blue-600 dark:text-blue-500 hover:underline mb-4">
                      ${IconBack()}
                      <span class="ml-1">Back to Dashboard</span>
                    </button>
                    
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">${set.title}</h1>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">${currentIndex + 1} / ${set.cards.length}</p>
              
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-6">
                      <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <!-- Flashcard -->
                    <div 
                      id="flashcard"
                      class="w-full h-96 card-flipper mb-6"
                    >
                      <div 
                        class="card-inner relative w-full h-full"
                      >
                        <!-- Front of Card (Term) -->
                        <div class="card-front absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6">
                          <p class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white text-center">${currentCard.term}</p>
                        </div>
                        <!-- Back of Card (Definition) -->
                        <div class="card-back absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6">
                          <p class="text-2xl md:text-3xl font-medium text-gray-800 dark:text-gray-200 text-center">${currentCard.definition}</p>
                        </div>
                      </div>
                    </div>
                    
                    <div class="text-center text-gray-500 dark:text-gray-400 text-sm mb-6">Click card to flip</div>
              
                    <!-- Navigation Controls -->
                    <div class="flex items-center justify-between mb-6">
                      <button
                        id="prev-card"
                        class="p-4 rounded-full bg-white dark:bg-gray-800 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200"
                        title="Previous Card"
                      >
                        ${IconPrev()}
                      </button>
                      
                      <button
                        id="flip-card"
                        class="flex items-center px-6 py-3 rounded-lg bg-white dark:bg-gray-800 shadow-md font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"
                        title="Flip Card"
                      >
                        ${IconFlip()}
                        <span class="ml-2">Flip</span>
                      </button>
                      
                      <button
                        id="next-card"
                        class="p-4 rounded-full bg-white dark:bg-gray-800 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200"
                        title="Next Card"
                      >
                        ${IconNext()}
                      </button>
                    </div>
                    
                    <!-- Known/Unknown Button -->
                     <button
                      id="toggle-known"
                      class="w-full py-4 rounded-lg font-bold text-lg transition-colors ${
                        isKnown
                          ? 'bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800'
                          : 'bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900 dark:text-green-300 dark:hover:bg-green-800'
                      }"
                    >
                      ${isKnown ? 'Mark as Unknown' : 'Mark as Known'}
                    </button>
                `;
                
                // Re-attach listeners for this view
                document.getElementById('study-page-back').addEventListener('click', () => navigate('dashboard'));
                
                const card = document.getElementById('flashcard');
                card.addEventListener('click', handleFlip);
                
                document.getElementById('flip-card').addEventListener('click', handleFlip);
                document.getElementById('prev-card').addEventListener('click', prevCard);
                document.getElementById('next-card').addEventListener('click', nextCard);
                document.getElementById('toggle-known').addEventListener('click', toggleKnown);
                
                if (isFlipped) {
                    card.classList.add('card-flipped');
                }
            }
            
            function handleFlip() {
                isFlipped = !isFlipped;
                const card = document.getElementById('flashcard');
                if (isFlipped) {
                    card.classList.add('card-flipped');
                } else {
                    card.classList.remove('card-flipped');
                }
            }
            
            function nextCard() {
                isFlipped = false;
                if (currentIndex < set.cards.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                } else {
                    // Reached end, check for completion
                    if (knownCards.size === set.cards.length) {
                        showComplete = true;
                        // Trigger confetti
                        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    } else {
                        setCurrentIndex(0); // Loop back to start
                    }
                }
                renderStudyUI();
            }

            function prevCard() {
                isFlipped = false;
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                } else {
                    setCurrentIndex(set.cards.length - 1); // Loop to end
                }
                renderStudyUI();
            }
            
            function toggleKnown() {
                const cardKey = set.cards[currentIndex].term;
                
                if (knownCards.has(cardKey)) {
                    knownCards.delete(cardKey);
                } else {
                    knownCards.add(cardKey);
                }
                
                // Auto-advance to next card if marked as known
                if (knownCards.has(cardKey)) {
                    // Check for completion right here
                    if (knownCards.size === set.cards.length) {
                        showComplete = true;
                        // Trigger confetti
                        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                        renderStudyUI();
                    } else {
                        nextCard();
                    }
                } else {
                    renderStudyUI();
                }
            }

            function restart() {
                currentIndex = 0;
                isFlipped = false;
                knownCards = new Set();
                showComplete = false;
                document.getElementById('study-complete-modal').classList.add('hidden');
                renderStudyUI();
            }
        }
        
        // --- QUIZ PAGE ---
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        
        function QuizPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto" id="quiz-page-container">
                  <p class="text-gray-700 dark:text-gray-300">Loading quiz...</p>
                </div>
                
                <!-- Quiz Completion Modal -->
                <div id="quiz-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                  <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Quiz Complete!</h3>
                    <p class="mt-4 text-3xl font-bold text-gray-800 dark:text-white" id="quiz-score-display"></p>
                    <p class="mt-2 text-lg text-gray-600 dark:text-gray-400" id="quiz-score-message"></p>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                      <button
                        type="button"
                        id="quiz-restart-btn"
                        class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                      >
                        Try Again
                      </button>
                      <button
                        type="button"
                        id="quiz-back-btn"
                        class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"
                      >
                        Back to Dashboard
                      </button>
                    </div>
                  </div>
                </div>
            `;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function generateQuiz(cards) {
            quizQuestions = [];
            
            // Create a "pool" of wrong answers
            const definitionsPool = cards.map(card => card.definition);
            
            for (const card of cards) {
                const question = card.term;
                const correctAnswer = card.definition;
                
                // Get 3 random wrong answers from the pool
                let wrongAnswers = [];
                const tempPool = definitionsPool.filter(d => d !== correctAnswer);
                shuffleArray(tempPool);
                
                wrongAnswers = tempPool.slice(0, 3);
                
                // Create 4 options and shuffle them
                const options = shuffleArray([
                    { text: correctAnswer, correct: true },
                    { text: wrongAnswers[0], correct: false },
                    { text: wrongAnswers[1], correct: false },
                    { text: wrongAnswers[2], correct: false },
                ]);
                
                quizQuestions.push({ question, options });
            }
            
            // Shuffle the final question list
            shuffleArray(quizQuestions);
            currentQuizIndex = 0;
            quizScore = 0;
        }
        
        async function attachQuizListeners(setId) {
            const container = document.getElementById('quiz-page-container');
            
            try {
                const docRef = doc(db, "studySets", setId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const set = docSnap.data();
                    if (set.cards.length < 4) {
                        throw new Error("Quiz requires at least 4 cards.");
                    }
                    generateQuiz(set.cards);
                    renderQuizQuestion();
                } else {
                    throw new Error("Study set not found.");
                }
            } catch (err) {
                console.error("Error loading quiz:", err);
                container.innerHTML = `<p class="text-red-600">${err.message}</p>
                    <button id="back-to-dash" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md">Back to Dashboard</button>`;
                document.getElementById('back-to-dash').addEventListener('click', () => navigate('dashboard'));
            }
        }
        
        function renderQuizQuestion(feedback = null, selectedOption = -1, correctOption = -1) {
            const container = document.getElementById('quiz-page-container');
            if (currentQuizIndex >= quizQuestions.length) {
                // Quiz is over!
                showQuizResults();
                return;
            }
            
            const q = quizQuestions[currentQuizIndex];
            const progressPercent = ((currentQuizIndex) / quizQuestions.length) * 100;
            
            container.innerHTML = `
                <button id="quiz-page-back" class="flex items-center text-blue-600 dark:text-blue-500 hover:underline mb-4">
                  ${IconBack()}
                  <span class="ml-1">Back to Dashboard</span>
                </button>
                
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Quiz Time!</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Question ${currentQuizIndex + 1} / ${quizQuestions.length}</p>
          
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-6">
                  <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                </div>
                
                <!-- Question -->
                <div class="w-full min-h-[10rem] bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6 mb-8">
                  <p class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white text-center">${q.question}</p>
                </div>
                
                <!-- Options -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="quiz-options">
                    ${q.options.map((option, index) => `
                        <button 
                            class="quiz-option p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg text-lg font-medium text-gray-800 dark:text-gray-200 text-left hover:shadow-xl hover:ring-2 hover:ring-blue-500 transition-all ${
                                feedback && index === correctOption ? 'bg-green-100 dark:bg-green-900 ring-2 ring-green-500' : ''
                            } ${
                                feedback === 'incorrect' && index === selectedOption ? 'bg-red-100 dark:bg-red-900 ring-2 ring-red-500' : ''
                            }"
                            data-index="${index}"
                            ${feedback ? 'disabled' : ''}
                        >
                            ${option.text}
                        </button>
                    `).join('')}
                </div>
                
                <!-- Feedback & Next Button -->
                <div id="feedback-container" class="mt-6 h-16">
                    ${feedback ? `
                        <div class="text-center">
                            <p class="text-2xl font-bold ${feedback === 'correct' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${feedback === 'correct' ? 'Correct!' : 'Incorrect'}
                            </p>
                            <button id="next-question-btn" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md">Next</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Attach listeners
            document.getElementById('quiz-page-back').addEventListener('click', () => navigate('dashboard'));
            
            if (feedback) {
                document.getElementById('next-question-btn').addEventListener('click', () => {
                    currentQuizIndex++;
                    renderQuizQuestion();
                });
            } else {
                document.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const selectedIndex = parseInt(btn.dataset.index);
                        const correctIndex = q.options.findIndex(opt => opt.correct);
                        
                        if (selectedIndex === correctIndex) {
                            quizScore++;
                            renderQuizQuestion('correct', selectedIndex, correctIndex);
                        } else {
                            renderQuizQuestion('incorrect', selectedIndex, correctIndex);
                        }
                    });
                });
            }
        }
        
        function showQuizResults() {
            const modal = document.getElementById('quiz-complete-modal');
            const scoreDisplay = document.getElementById('quiz-score-display');
            const scoreMessage = document.getElementById('quiz-score-message');
            
            const percent = Math.round((quizScore / quizQuestions.length) * 100);
            scoreDisplay.textContent = `${percent}%`;
            scoreMessage.textContent = `You got ${quizScore} out of ${quizQuestions.length} correct.`;
            
            modal.classList.remove('hidden');
            
            if (percent === 100) {
                // Trigger confetti
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            }
            
            document.getElementById('quiz-restart-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                attachQuizListeners(currentSetId); // This re-fetches and re-generates
            });
            document.getElementById('quiz-back-btn').addEventListener('click', () => navigate('dashboard'));
        }
        
        // --- LEARN SETUP PAGE ---
        function LearnSetupPageHTML(setId) {
            return `
                <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl">
                    <button id="learn-setup-back" class="flex items-center text-blue-600 dark:text-blue-500 hover:underline mb-6">
                        ${IconBack()}
                        <span class="ml-1">Back to Set</span>
                    </button>
                    
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Learn Mode Setup</h1>
                    
                    <form id="learn-setup-form" class="space-y-8">
                        <div>
                            <label class="block text-lg font-medium text-gray-700 dark:text-gray-200">Session Size</label>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">How many cards do you want to study?</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="radio" name="sessionSize" value="10" class="sr-only">
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Small (10 cards)</span>
                                </label>
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="radio" name="sessionSize" value="20" class="sr-only">
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Medium (20 cards)</span>
                                </label>
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="radio" name="sessionSize" value="all" class="sr-only" checked>
                                    <span class="font-medium text-gray-800 dark:text-gray-200">All Cards</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-lg font-medium text-gray-700 dark:text-gray-200">Question Types</label>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">How do you want to be tested?</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="checkbox" name="questionType" value="mc" class="sr-only" checked>
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Multiple Choice</span>
                                </label>
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="checkbox" name="questionType" value="typed" class="sr-only">
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Typed Answer</span>
                                </label>
                            </div>
                            <p id="type-error" class="text-red-600 text-sm mt-2 hidden">Please select at least one question type.</p>
                        </div>
                        
                        <div>
                            <label class="block text-lg font-medium text-gray-700 dark:text-gray-200">Prompt With</label>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">What side of the card do you want to see first?</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="radio" name="promptWith" value="term" class="sr-only" checked>
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Term</span>
                                </label>
                                <label class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-gray-700 has-[:checked]:ring-2 has-[:checked]:ring-blue-500">
                                    <input type="radio" name="promptWith" value="definition" class="sr-only">
                                    <span class="font-medium text-gray-800 dark:text-gray-200">Definition</span>
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full py-3 px-6 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            Start Learning
                        </button>
                    </form>
                </div>
            `;
        }
        
        function attachLearnSetupListeners(setId) {
            document.getElementById('learn-setup-back').addEventListener('click', () => navigate('edit', setId));
            
            document.getElementById('learn-setup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const size = formData.get('sessionSize');
                const types = formData.getAll('questionType');
                const prompt = formData.get('promptWith');
                
                const typeError = document.getElementById('type-error');
                if (types.length === 0) {
                    typeError.classList.remove('hidden');
                    return;
                }
                typeError.classList.add('hidden');
                
                learnSettings = {
                    setId,
                    size,
                    types,
                    prompt
                };
                
                console.log("Learn Settings:", learnSettings);
                navigate('learn');
            });
        }
        
        // --- LEARN PAGE ---
        let learnSession = {
            allCards: [],
            wrongPile: [],
            currentCard: null,
            questionType: null,
            promptWith: 'term',
            masteredCount: 0,
            sessionSize: 0
        };
        
        function LearnPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto" id="learn-page-container">
                    <p class="text-gray-700 dark:text-gray-300">Loading learning session...</p>
                </div>
                
                <!-- Learn Completion Modal -->
                <div id="learn-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                  <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Session Complete!</h3>
                    <p class="mt-4 text-lg text-gray-600 dark:text-gray-400" id="learn-complete-message"></p>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                      <button
                        type="button"
                        id="learn-restart-btn"
                        class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                      >
                        Start New Session
                      </button>
                      <button
                        type="button"
                        id="learn-back-btn"
                        class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"
                      >
                        Back to Dashboard
                      </button>
                    </div>
                  </div>
                </div>
            `;
        }
        
        async function attachLearnListeners(setId) {
            const container = document.getElementById('learn-page-container');
            
            try {
                // 1. Fetch the set
                const docRef = doc(db, "studySets", setId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    throw new Error("Study set not found.");
                }
                
                let allCards = docSnap.data().cards;
                shuffleArray(allCards);
                
                // 2. Apply settings
                if (learnSettings.size !== 'all') {
                    allCards = allCards.slice(0, parseInt(learnSettings.size));
                }
                
                learnSession.allCards = shuffleArray([...allCards]); // This is the main pile
                learnSession.wrongPile = [];
                learnSession.masteredCount = 0;
                learnSession.sessionSize = learnSession.allCards.length;
                learnSession.promptWith = learnSettings.prompt;
                
                if (learnSession.sessionSize === 0) {
                    throw new Error("No cards to study in this session.");
                }
                
                // 3. Start the session
                nextLearnQuestion();
                
            } catch (err) {
                console.error("Error loading learn session:", err);
                container.innerHTML = `<p class="text-red-600">${err.message}</p>
                    <button id="back-to-dash" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md">Back to Dashboard</button>`;
                document.getElementById('back-to-dash').addEventListener('click', () => navigate('dashboard'));
            }
        }
        
        function nextLearnQuestion() {
            // Are we done?
            if (learnSession.masteredCount === learnSession.sessionSize) {
                showLearnResults();
                return;
            }
            
            // Do we have any "wrong" cards to re-study?
            if (learnSession.wrongPile.length > 0) {
                learnSession.currentCard = learnSession.wrongPile.shift();
            } else {
                // Get the next card from the main pile
                learnSession.currentCard = learnSession.allCards.pop();
            }
            
            // What kind of question?
            const types = learnSettings.types;
            learnSession.questionType = types[Math.floor(Math.random() * types.length)];
            
            // Render the UI
            renderLearnQuestion();
        }
        
        function renderLearnQuestion(feedback = null, userAnswer = null) {
            const container = document.getElementById('learn-page-container');
            const card = learnSession.currentCard;
            
            const [question, answer] = learnSession.promptWith === 'term' 
                ? [card.term, card.definition] 
                : [card.definition, card.term];
                
            const progressPercent = (learnSession.masteredCount / learnSession.sessionSize) * 100;

            let questionHTML = '';
            if (learnSession.questionType === 'mc') {
                // Generate MC options
                const allAnswers = learnSession.allCards.concat(learnSession.wrongPile).map(c => learnSession.promptWith === 'term' ? c.definition : c.term);
                const tempPool = allAnswers.filter(a => a !== answer);
                shuffleArray(tempPool);
                
                const options = shuffleArray([
                    { text: answer, correct: true },
                    { text: tempPool[0], correct: false },
                    { text: tempPool[1], correct: false },
                    { text: tempPool[2], correct: false },
                ]);
                
                questionHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${options.map((option, index) => {
                            let colorClass = 'bg-white dark:bg-gray-800 hover:shadow-xl hover:ring-2 hover:ring-blue-500';
                            if (feedback && option.correct) {
                                colorClass = 'bg-green-100 dark:bg-green-900 ring-2 ring-green-500';
                            } else if (feedback === 'incorrect' && option.text === userAnswer) {
                                colorClass = 'bg-red-100 dark:bg-red-900 ring-2 ring-red-500';
                            }
                            
                            return `
                            <button 
                                class="learn-option p-6 rounded-lg shadow-lg text-lg font-medium text-gray-800 dark:text-gray-200 text-left transition-all ${colorClass}"
                                data-answer="${option.text}"
                                ${feedback ? 'disabled' : ''}
                            >
                                ${option.text}
                            </button>
                            `;
                        }).join('')}
                    </div>
                `;
            } else { // Typed Answer
                questionHTML = `
                    <form id="learn-typed-form">
                        <input
                          type="text"
                          id="learn-typed-input"
                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-lg"
                          placeholder="Type your answer..."
                          ${feedback ? 'disabled' : ''}
                        />
                        <button type="submit" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-md ${feedback ? 'hidden' : ''}">Check</button>
                    </form>
                `;
            }
            
            container.innerHTML = `
                <button id="learn-page-back" class="flex items-center text-blue-600 dark:text-blue-500 hover:underline mb-4">
                  ${IconBack()}
                  <span class="ml-1">Quit Session</span>
                </button>
                
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Learn Mode</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Mastered: ${learnSession.masteredCount} / ${learnSession.sessionSize}</p>
          
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-6">
                  <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                </div>
                
                <!-- Question -->
                <div class="w-full min-h-[10rem] bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6 mb-8">
                  <p class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white text-center">${question}</p>
                </div>
                
                <!-- Answer Area -->
                <div id="learn-answer-area">
                    ${questionHTML}
                </div>
                
                <!-- Feedback & Next Button -->
                <div id="learn-feedback-container" class="mt-6">
                    ${feedback ? `
                        <div class="p-6 rounded-lg ${feedback === 'correct' ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}">
                            <p class="text-2xl font-bold ${feedback === 'correct' ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">
                                ${feedback === 'correct' ? 'Correct!' : 'Incorrect'}
                            </p>
                            ${feedback === 'incorrect' ? `
                                <p class="text-lg mt-2 text-gray-800 dark:text-gray-200">The correct answer was: <strong>${answer}</strong></p>
                            ` : ''}
                            <button id="next-learn-btn" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md">Continue</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Attach Listeners
            document.getElementById('learn-page-back').addEventListener('click', () => navigate('dashboard'));
            
            if (feedback) {
                document.getElementById('next-learn-btn').addEventListener('click', nextLearnQuestion);
            } else {
                if (learnSession.questionType === 'mc') {
                    document.querySelectorAll('.learn-option').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const selectedAnswer = btn.dataset.answer;
                            handleLearnAnswer(selectedAnswer);
                        });
                    });
                } else { // Typed
                    document.getElementById('learn-typed-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const typedAnswer = document.getElementById('learn-typed-input').value;
                        handleLearnAnswer(typedAnswer);
                    });
                }
            }
        }
        
        function handleLearnAnswer(userAnswer) {
            const card = learnSession.currentCard;
            const correctAnswer = learnSession.promptWith === 'term' ? card.definition : card.term;
            
            // Simple check, case-insensitive and trim
            const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
            
            if (isCorrect) {
                learnSession.masteredCount++;
                // This card is done for the session. Don't add to wrongPile.
                renderLearnQuestion('correct', userAnswer);
            } else {
                // Add to wrong pile to be re-asked
                learnSession.wrongPile.push(card);
                renderLearnQuestion('incorrect', userAnswer);
            }
        }
        
        function showLearnResults() {
            const modal = document.getElementById('learn-complete-modal');
            const scoreMessage = document.getElementById('learn-complete-message');
            
            scoreMessage.textContent = `Great job! You've mastered all ${learnSession.sessionSize} cards in this session.`;
            modal.classList.remove('hidden');
            
            // Trigger confetti
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
            
            document.getElementById('learn-restart-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                navigate('learnSetup', currentSetId); // Go back to setup
            });
            document.getElementById('learn-back-btn').addEventListener('click', () => navigate('dashboard'));
        }

        // --- AUTH STATE LISTENER ---
        // This is the entry point of the app
        onAuthStateChanged(auth, (user) => {
            if (user) {
                globalUser = user;
                if (currentPage === 'auth') {
                    currentPage = 'dashboard';
                }
            } else {
                globalUser = null;
                currentPage = 'auth';
            }
            globalAuthLoaded = true;
            render();
        });

    </script>
</body>
</html>

