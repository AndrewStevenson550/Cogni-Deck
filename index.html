<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniDeck - AI Study Sets</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- pdf.js (for client-side PDF reading) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    </script>
    
    <!-- Confetti (for celebrations) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config & Dark Mode Setup -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    // Custom styles for 3D card flip
                    transitionProperty: {
                        'transform': 'transform',
                    },
                    transformStyle: {
                        'preserve-3d': 'preserve-3d',
                    },
                    backfaceVisibility: {
                        'hidden': 'hidden',
                    },
                    rotate: {
                        'y-180': 'rotateY(180deg)',
                    },
                },
            },
            plugins: [
                function({ addUtilities }) {
                    addUtilities({
                        '.[transform-style\\:preserve-3d]': {
                            'transform-style': 'preserve-3d',
                        },
                        '.[backface-visibility\\:hidden]': {
                            'backface-visibility': 'hidden',
                        },
                        '.[transform\\:rotateY\\(180deg\\)]': {
                            'transform': 'rotateY(180deg)',
                        },
                        '.line-clamp-2': {
                            'overflow': 'hidden',
                            'display': '-webkit-box',
                            '-webkit-box-orient': 'vertical',
                            '-webkit-line-clamp': '2',
                        },
                    });
                }
            ],
        };
        
        // --- DARK MODE LOGIC ---
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    
    <!-- Custom Styles for 3D card flip -->
    <style>
        /* This is necessary for the card flip */
        .card-flipper {
            perspective: 1000px;
        }
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* Safari */
        }
        .card-back {
            transform: rotateY(180deg);
        }
    </style>
    
    <!-- === GOOGLE ADSENSE SCRIPT === -->
    <!-- This is the main script from your AdSense account -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2643963093121190"
     crossorigin="anonymous"></script>
</head>
<body class="font-inter bg-gray-100 dark:bg-gray-900">
    <!-- Main App Container -->
    <div id="app">
        <!-- This is where the app will be rendered by JavaScript -->
        <!-- FIXED: Corrected 'classclass' to 'class' -->
        <div class="flex items-center justify-center h-screen">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Loading CogniDeck...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
          getAuth,
          signInWithEmailAndPassword,
          createUserWithEmailAndPassword,
          signOut,
          onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
          getFirestore,
          collection,
          addDoc,
          doc,
          getDoc,
          getDocs,
          updateDoc,
          deleteDoc,
          query,
          where,
          onSnapshot,
          serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // We are NOT using functions, so we don't import it.


        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE ---
        // This is the config you provided earlier.
        const firebaseConfig = {
          apiKey: "AIzaSyDaTxyHz5dr4aWCE4tAiql4jJ4ImrrJKQM",
          authDomain: "quizlet-type-app.firebaseapp.com",
          projectId: "quizlet-type-app",
          storageBucket: "quizlet-type-app.firebasestorage.app",
          messagingSenderId: "829739254487",
          appId: "1:829739254487:web:457ffc620af28c96f8a692"
        };
        
        // --- IMPORTANT: PASTE YOUR GEMINI API KEY HERE ---
        // This is the key you provided from Google AI Studio
        // WARNING: This is NOT secure for a public website!
        const GEMINI_API_KEY = "AIzaSyDxNcI0uaa1C6z6mc09lINO7rLcNe2xyig";


        // --- FIREBASE & APP INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug'); // Use 'Debug' for detailed logs

        // --- GLOBAL APP STATE ---
        let globalUser = null;
        let globalAuthLoaded = false;
        let currentPage = 'auth';
        let currentSetId = null;
        let learnSettings = {}; // Store settings for learn mode
        let dashboardUnsubscribe = null; // To store the dashboard listener
        let searchUnsubscribe = null; // To store the search listener

        const appContainer = document.getElementById('app');

        // --- NAVIGATION ---
        function navigate(page, setId = null) {
            // Unsubscribe from live listeners when leaving a page
            if (currentPage === 'dashboard' && page !== 'dashboard' && dashboardUnsubscribe) {
                console.log("Unsubscribing from dashboard");
                dashboardUnsubscribe();
                dashboardUnsubscribe = null;
            }
            if (currentPage === 'search' && page !== 'search' && searchUnsubscribe) {
                console.log("Unsubscribing from search");
                searchUnsubscribe();
                searchUnsubscribe = null;
            }

            currentPage = page;
            currentSetId = setId;
            render();
        }

        // --- RENDER FUNCTION ---
        // This is the main function that builds the UI
        function render() {
            if (!globalAuthLoaded) {
                appContainer.innerHTML = FullScreenLoader();
                return;
            }

            let pageHTML = '';
            
            // Show navbar on all pages except auth
            if (globalUser && currentPage !== 'auth') {
                pageHTML += NavbarHTML();
            }
            
            // Add main content with sidebars
            pageHTML += `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">`;
            pageHTML += `<div class="flex justify-center space-x-8">`;
            
            // Left Ad Sidebar (hidden on mobile)
            pageHTML += `
                <div class="hidden lg:block w-48 flex-shrink-0">
                    <div class="sticky top-24 w-48 h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <!-- PASTE AD SENSE CODE HERE -->
                        Ad Placeholder (160x600)
                    </div>
                </div>
            `;
            
            // Main Page Content
            pageHTML += `<div class="flex-grow min-w-0" style="max-width: 1024px;">`; // Main content container
            
            switch (currentPage) {
                case 'auth':
                    pageHTML = AuthPageHTML(); // Auth page is full screen, so replace all HTML
                    break;
                case 'dashboard':
                    pageHTML += DashboardPageHTML();
                    break;
                case 'search':
                    pageHTML += SearchPageHTML();
                    break;
                case 'upload':
                    pageHTML += UploadPageHTML();
                    break;
                case 'create':
                    pageHTML += SetEditorHTML();
                    break;
                case 'edit':
                    pageHTML += SetEditorHTML(currentSetId);
                    break;
                case 'study':
                    pageHTML += StudyPageHTML(currentSetId);
                    break;
                case 'quiz':
                    pageHTML += QuizPageHTML(currentSetId);
                    break;
                case 'learnSetup':
                    pageHTML += LearnSetupPageHTML(currentSetId);
                    break;
                case 'learn':
                    pageHTML += LearnPageHTML(currentSetId);
                    break;
                case 'about':
                    pageHTML += AboutPageHTML();
                    break;
                default:
                    pageHTML += DashboardPageHTML();
            }
            
            pageHTML += `</div>`; // End Main content container
            
            // Right Ad Sidebar (hidden on mobile)
            pageHTML += `
                <div class="hidden lg:block w-48 flex-shrink-0">
                    <div class="sticky top-24 w-48 h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <!-- PASTE AD SENSE CODE HERE -->
                        Ad Placeholder (160x600)
                    </div>
                </div>
            `;
            
            pageHTML += `</div>`; // End flex container
            pageHTML += `</div>`; // End max-w-7xl

            // Handle auth page (which has no navbar or sidebars)
            if (currentPage === 'auth') {
                appContainer.innerHTML = pageHTML;
            } else {
                appContainer.innerHTML = pageHTML;
            }

            // Attach event listeners after HTML is rendered
            attachAllListeners();
        }

        // --- EVENT LISTENER ATTACHMENT ---
        // This function finds all elements by ID and attaches their JS listeners
        function attachAllListeners() {
            // Dark Mode Toggle
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleDarkMode);
            }
            const mobileThemeToggleBtn = document.getElementById('mobile-theme-toggle');
            if (mobileThemeToggleBtn) {
                mobileThemeToggleBtn.addEventListener('click', toggleDarkMode);
            }
            
            // Mobile Menu
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }

            // Page-specific listeners
            switch (currentPage) {
                case 'auth':
                    attachAuthListeners();
                    break;
                case 'dashboard':
                    attachDashboardListeners();
                    break;
                case 'search':
                    attachSearchListeners();
                    break;
                case 'upload':
                    attachUploadListeners();
                    break;
                case 'create':
                    attachSetEditorListeners();
                    break;
                case 'edit':
                    attachSetEditorListeners(currentSetId);
                    break;
                case 'study':
                    attachStudyListeners(currentSetId);
                    break;
                case 'quiz':
                    attachQuizListeners(currentSetId);
                    break;
                case 'learnSetup':
                    attachLearnSetupListeners(currentSetId);
                    break;
                case 'learn':
                    attachLearnListeners(currentSetId);
                    break;
                // No listeners needed for About or Navbar
            }
            
            // Navbar listeners (need to be attached even if page is e.g. 'dashboard')
            if (globalUser) {
                attachNavbarListeners();
            }
        }

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            // Check if dark mode is currently enabled
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            // Re-render to update icons (sun/moon)
            render();
        }

        // --- ICONS (as functions returning strings) ---
        const IconHome = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>`;
        const IconSearch = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>`;
        const IconUpload = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>`;
        const IconPlus = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;
        const IconLogout = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>`;
        const IconTrash = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.502 0c.342.052.682.107 1.022.166m11.48 0c.342.052.682.107 1.022.166M4.772 5.79L4.772 5.79m14.456 0l-2.81-2.98m-11.48 0l2.81 2.98m0 0l-2.81 2.98m11.48 0l2.81 2.98" /></svg>`;
        const IconEdit = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`;
        const IconBack = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
        const IconFlip = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0 0v-4.992m0 0h-4.992" /></svg>`;
        const IconNext = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
        const IconPrev = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
        const IconPublic = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c.24 0 .477-.007.71-.021M12 21c-.24 0-.477-.007-.71-.021M12 15a3.75 3.75 0 003.75-3.75V8.25A3.75 3.75 0 0012 4.5v.001M12 15a3.75 3.75 0 01-3.75-3.75V8.25A3.75 3.75 0 0112 4.5v.001M12 15v.001M12 4.5v.001m0 0v.001m0 0h.001M12 15h.001M12 4.5h.001M12 3c-1.928 0-3.69.784-4.95 2.05S4.5 8.072 4.5 10v.75a8.217 8.217 0 004.22 7.029c.465.253.96.442 1.48.59M12 3c1.928 0 3.69.784 4.95 2.05S19.5 8.072 19.5 10v.75a8.217 8.217 0 01-4.22 7.029c-.465.253-.96.442-1.48.59M12 3v.001" /></svg>`;
        const IconPrivate = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>`;
        const IconCheck = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
        const IconAI = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 21.75l-.648-1.188a2.25 2.25 0 00-1.579-1.579L12.75 18.25l1.188-.648a2.25 2.25 0 001.579-1.579L16.25 15l.648 1.188a2.25 2.25 0 001.579 1.579L19.75 18.25l-1.188.648a2.25 2.25 0 00-1.579 1.579z" /></svg>`;
        const IconBook = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.105 0 4.059.983 5.25 2.688.097.132.2.263.3.391.098.127.203.25.308.371l.01.01.006.007.002.002.002.002.006.007.01.01c.098.12.206.24.314.368.106.126.21.25.312.37.112.128.22.25.324.368.216.239.423.47.625.69.106.115.207.224.306.33a8.952 8.952 0 005.25-2.688c.938-.332 1.948-.512 3-.512h.001v-14.25c-.938.332-1.948.512-3 .512a8.967 8.967 0 00-6-2.292z" /></svg>`;
        const IconQuiz = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25c.092-.004.186-.006.281-.006H14.25l4.5 4.5v1.875M10.125 2.25L10.5 6h4.125L18.75 2.625M10.125 6.375L10.5 10.5h4.125L18.75 6.875M10.125 10.875L10.5 15h4.125L18.75 11.375M10.125 15.375L10.5 19.5h4.125L18.75 15.875" /></svg>`;
        const IconLearn = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 000 7.706c0 1.518.81 2.818 2.12 3.664a4.5 4.5 0 006.016-1.583A6.002 6.002 0 0014.25 18.001c.22.82.78 1.518 1.62 1.984A4.5 4.5 0 0021.75 18c.21-.82.4-1.67.4-2.553a60.437 60.437 0 000-7.706c0-1.518-.81-2.818-2.12-3.664a4.5 4.5 0 00-6.016 1.583A6.002 6.002 0 009.75 6.001c-.22-.82-.78-1.518-1.62-1.984A4.5 4.5 0 002.25 6c-.21.82-.4 1.67-.4 2.553z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9c0 .052.002.105.005.157M15.75 9c0 1.203-.404 2.306-1.09 3.192M15.75 9c.39 1.34.409 2.766.052 4.105M15.75 9a4.498 4.498 0 00-4.498-4.498M15.75 9C13.56 9 12 7.44 12 5.25" /></svg>`;
        const IconInfo = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`;
        const IconSun = () => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M12 1.5a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V2.25A.75.75 0 0112 1.5zM18.82 5.18a.75.75 0 01.06 1.06l-1.5 1.5a.75.75 0 01-1.06-1.06l1.5-1.5a.75.75 0 011.06-.06zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM18.82 18.82a.75.75 0 011.06.06l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 01.06-1.06zM12 21.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V22.5a.75.75 0 01.75-.75zM5.18 18.82a.75.75 0 01.06-1.06l-1.5-1.5a.75.75 0 01-1.06 1.06l1.5 1.5a.75.75 0 011.06.06zM2.25 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3a.75.75 0 01-.75-.75zM5.18 5.18a.75.75 0 011.06-.06l-1.5 1.5a.75.75 0 01-1.06-1.06l1.5-1.5a.75.75 0 01.06-1.06zM12 6.75a5.25 5.25 0 100 10.5 5.25 5.25 0 000-10.5z" clip-rule="evenodd" /></svg>`;
        const IconMoon = () => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>`;

        // --- COMPONENTS (as functions returning HTML strings) ---

        function FullScreenLoader() {
            return `
                <div class="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
                  <div class="flex flex-col items-center">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Loading CogniDeck...</p>
                  </div>
                </div>
            `;
        }

        function NavbarHTML() {
            const isDark = document.documentElement.classList.contains('dark');
            
            // This helper function now correctly uses `currentPage` from the global scope
            const NavButton = (page, icon, label) => `
                <button
                    id="nav-${page}"
                    class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium ${
                    currentPage === page
                      ? 'bg-blue-600 text-white'
                      : 'text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-800 hover:text-blue-700 dark:hover:text-blue-400'
                  }"
                >
                  ${icon}
                  <span>${label}</span>
                </button>
            `;
            
            // This helper function now correctly uses `currentPage` from the global scope
            const MobileNavButton = (page, icon, label) => `
                <button
                    id="mobile-nav-${page}"
                    class="flex items-center w-full px-4 py-3 text-base font-medium rounded-md ${
                    currentPage === page
                      ? 'bg-blue-100 dark:bg-gray-800 text-blue-700 dark:text-blue-400'
                      : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
                  }"
                >
                  ${icon}
                  <span class="ml-3">${label}</span>
                </button>
            `;

            return `
                <nav class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md dark:shadow-gray-700 z-50">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                      
                      <!-- Logo -->
                      <div class="flex-shrink-0 flex items-center cursor-pointer" id="nav-logo">
                        <span class="text-2xl font-bold text-blue-600 dark:text-blue-500">CogniDeck</span>
                      </div>

                      <!-- Desktop Nav -->
                      <div class="hidden md:flex md:items-center md:space-x-4">
                        ${NavButton('dashboard', IconHome(), 'Home')}
                        ${NavButton('search', IconSearch(), 'Search')}
                        ${NavButton('upload', IconUpload(), 'Import')}
                        ${NavButton('about', IconInfo(), 'About')}
                        <button
                          id="nav-create"
                          class="ml-4 flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                        >
                          ${IconPlus()}
                          <span class="ml-2">Create Set</span>
                        </button>
                      </div>

                      <!-- User Menu (Desktop) -->
                      <div class="hidden md:flex items-center space-x-3">
                         <button
                           id="theme-toggle"
                           class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                           title="Toggle dark mode"
                         >
                           ${isDark ? IconSun() : IconMoon()}
                         </button>
                         <span class="text-sm text-gray-600 dark:text-gray-300 hidden lg:block">${globalUser.email}</span>
                         <button
                          id="nav-signout"
                          class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                          title="Sign Out"
                        >
                          ${IconLogout()}
                        </button>
                      </div>
                      
                      <!-- Mobile Menu Button -->
                      <div class="md:hidden flex items-center">
                        <button
                           id="mobile-theme-toggle"
                           class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                           title="Toggle dark mode"
                         >
                           ${isDark ? IconSun() : IconMoon()}
                         </button>
                        <button
                          id="mobile-menu-btn"
                          class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700"
                          aria-controls="mobile-menu"
                          aria-expanded="false"
                        >
                          <span class="sr-only">Open main menu</span>
                          <svg id="mobile-menu-icon-open" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                          </svg>
                          <svg id="mobile-menu-icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>

                    </div>
                  </div>

                  <!-- Mobile Menu -->
                  <div class="hidden md:hidden" id="mobile-menu">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                      ${MobileNavButton('dashboard', IconHome(), 'Home')}
                      ${MobileNavButton('search', IconSearch(), 'Search')}
                      ${MobileNavButton('upload', IconUpload(), 'Import')}
                      ${MobileNavButton('create', IconPlus(), 'Create Set')}
                      ${MobileNavButton('about', IconInfo(), 'About')}
                    </div>
                    <div class="pt-4 pb-3 border-t border-gray-200 dark:border-gray-700">
                      <div class="flex items-center px-5">
                        <div class="ml-3">
                          <div class="text-base font-medium text-gray-800 dark:text-gray-200">${globalUser.email}</div>
                        </div>
                      </div>
                      <div class="mt-3 px-2 space-y-1">
                        <button
                          id="mobile-nav-signout"
                          class="flex items-center w-full px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"
                        >
                          ${IconLogout()}
                          <span class="ml-3">Sign out</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </nav>
            `;
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const iconOpen = document.getElementById('mobile-menu-icon-open');
            const iconClose = document.getElementById('mobile-menu-icon-close');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                iconOpen.classList.add('hidden');
                iconClose.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
                iconOpen.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        }
        
        function attachNavbarListeners() {
            // Desktop listeners
            document.getElementById('nav-logo').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-search').addEventListener('click', () => navigate('search'));
            document.getElementById('nav-upload').addEventListener('click', () => navigate('upload'));
            document.getElementById('nav-about').addEventListener('click', () => navigate('about'));
            document.getElementById('nav-create').addEventListener('click', () => navigate('create'));
            document.getElementById('nav-signout').addEventListener('click', handleSignOut);
            
            // Mobile listeners
            document.getElementById('mobile-nav-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('mobile-nav-search').addEventListener('click', () => navigate('search'));
            document.getElementById('mobile-nav-upload').addEventListener('click', () => navigate('upload'));
            document.getElementById('mobile-nav-create').addEventListener('click', () => navigate('create'));
            document.getElementById('mobile-nav-about').addEventListener('click', () => navigate('about'));
            document.getElementById('mobile-nav-signout').addEventListener('click', handleSignOut);
        }
        
        async function handleSignOut() {
            try {
              await signOut(auth);
              // Auth listener will handle success
            } catch (error) {
              console.error("Error signing out:", error);
              alert("Error signing out: " + error.message);
            }
        }

        function AuthPageHTML() {
            // This page is special, it's not wrapped in the ad container
            return `
                <div class="flex items-center justify-center min-h-screen -mt-16 bg-gray-100 dark:bg-gray-900">
                  <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                    <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">
                      Welcome to <span class="text-blue-600 dark:text-blue-500">CogniDeck</span>
                    </h2>
                    
                    <form class="space-y-6" id="auth-form">
                      <div>
                        <label
                          for="email"
                          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                        >
                          Email address
                        </label>
                        <input
                          id="email"
                          name="email"
                          type="email"
                          autoComplete="email"
                          required
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        />
                      </div>
                      <div>
                        <label
                          for="password"
                          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                        >
                          Password
                        </label>
                        <input
                          id="password"
                          name="password"
                          type="password"
                          autoComplete="current-password"
                          required
                          class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        />
                      </div>

                      <p id="auth-error" class="text-sm text-red-600 hidden"></p>

                      <button
                        type="submit"
                        id="auth-submit-btn"
                        class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                      >
                        Log In
                      </button>
                    </form>

                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                      <span id="auth-toggle-text">Don't have an account?</span>
                      <button
                        id="auth-toggle-btn"
                        class="ml-1 font-medium text-blue-600 dark:text-blue-500 hover:text-blue-500 dark:hover:text-blue-400"
                      >
                        Sign Up
                      </button>
                    </p>
                  </div>
                </div>
            `;
        }

        function attachAuthListeners() {
            const authForm = document.getElementById('auth-form');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authToggleBtn = document.getElementById('auth-toggle-btn');
            const authToggleText = document.getElementById('auth-toggle-text');
            const authError = document.getElementById('auth-error');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            let isLogin = true;

            authToggleBtn.addEventListener('click', () => {
                isLogin = !isLogin;
                if (isLogin) {
                    authSubmitBtn.textContent = 'Log In';
                    authToggleText.textContent = "Don't have an account?";
                    authToggleBtn.textContent = 'Sign Up';
                } else {
                    authSubmitBtn.textContent = 'Sign Up';
                    authToggleText.textContent = 'Already have an account?';
                    authToggleBtn.textContent = 'Log In';
                }
                authError.classList.add('hidden');
                authError.textContent = '';
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;

                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = isLogin ? 'Logging in...' : 'Signing up...';
                authError.classList.add('hidden');

                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    // Auth listener will handle success
                } catch (err) {
                    authError.textContent = err.message;
                    authError.classList.remove('hidden');
                    authSubmitBtn.disabled = false;
                    authSubmitBtn.textContent = isLogin ? 'Log In' : 'Sign Up';
                }
            });
        }
        
        function AboutPageHTML() {
            return `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-2xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 text-center">About CogniDeck</h1>
                    
                    <div class="space-y-6 text-gray-700 dark:text-gray-300">
                        <p>
                            <strong>CogniDeck</strong> is a free, AI-powered flashcard application built to make studying smarter, faster, and more accessible for everyone. It's built as a single, lightweight HTML file that connects to a powerful and free backend on Firebase.
                        </p>
                        
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Core Features</h2>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Create & Manage Sets:</strong> Easily create, edit, and delete your own study sets.</li>
                                <li><strong>Multiple Study Modes:</strong> Study with classic 3D Flashcards, a multiple-choice Quiz, or the smart "Learn" mode.</li>
                                <li><strong>AI Import:</strong> Upload a \`.txt\` or \`.pdf\` file and let Google's AI automatically generate flashcards for you.</li>
                                <li><strong>Search:</strong> Discover public sets created by other users.</li>
                                <li><strong>Dark Mode:</strong> Study any time, day or night, with a comfortable dark theme.</li>
                            </ul>
                        </div>
                        
                        <div class="p-4 bg-blue-50 dark:bg-gray-700 rounded-lg text-center">
                            <h2 class="text-xl font-semibold text-blue-800 dark:text-blue-300 mb-3">About the Creator</h2>
                            <p class="text-gray-700 dark:text-gray-300">
                                Hi, I'm <strong>Andrew Stevenson</strong>, a 14-year-old student with a passion for coding.
                            </p>
                            <p class="mt-2 text-gray-700 dark:text-gray-300">
                                I built CogniDeck from the ground up because I wanted to create a powerful study tool that was 100% free for students like me. This whole project was an amazing adventure in learning how to use technologies like Firebase, Google's Gemini AI, and Tailwind CSS to build something real. I hope you find it helpful for your classes!
                            </p>
                        </div>
                        
                        <p>
                            This project demonstrates how modern web technologies (HTML, JavaScript, and Tailwind CSS) can be combined with powerful cloud services (Firebase and Google AI) to create a full-featured, responsive application without a complex server setup.
                        </p>
                    </div>
                </div>
            `;
        }

        // --- DASHBOARD PAGE ---
        function DashboardPageHTML() {
            return `
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Your Study Sets</h1>
                  <div id="dashboard-set-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-700 dark:text-gray-300">Loading your sets...</p>
                  </div>
                </div>
            `;
        }

        function attachDashboardListeners() {
            const setsCollection = collection(db, "studySets");
            const q = query(setsCollection, where("ownerId", "==", globalUser.uid));
            
            const setListContainer = document.getElementById('dashboard-set-list');
            
            // Ensure we're on the right page before query
            if (!setListContainer) return;

            dashboardUnsubscribe = onSnapshot(q, (querySnapshot) => {
                // Add a check: only update if we are still on the dashboard page
                if (currentPage !== 'dashboard' || !document.getElementById('dashboard-set-list')) {
                    console.log("Dashboard listener fired, but not on dashboard page. Ignoring.");
                    return;
                }

                if (querySnapshot.empty) {
                    setListContainer.innerHTML = `
                        <div class="col-span-full text-center p-12 bg-white dark:bg-gray-800 rounded-lg shadow">
                          <h3 class="text-xl font-medium text-gray-800 dark:text-white">No sets yet!</h3>
                          <p class="text-gray-600 dark:text-gray-400 mt-2 mb-4">Create a set manually or import a document to get started.</p>
                          <button
                            id="dashboard-create-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                          >
                            ${IconPlus()}
                            <span class="ml-2">Create New Set</span>
                          </button>
                        </div>
                    `;
                    document.getElementById('dashboard-create-btn').addEventListener('click', () => navigate('create'));
                    return;
                }

                let setsHTML = '';
                querySnapshot.forEach((doc) => {
                    setsHTML += SetCardHTML(doc.id, doc.data());
                });
                setListContainer.innerHTML = setsHTML;
                
                // Add listeners for all the new cards
                querySnapshot.forEach((doc) => {
                    // Add checks to ensure elements exist before adding listeners
                    const studyBtn = document.getElementById(`study-${doc.id}`);
                    if (studyBtn) {
                        studyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (doc.data().cards && doc.data().cards.length > 0) {
                                navigate('study', doc.id);
                            } else {
                                alert("This set has no cards! Add cards to study.");
                                navigate('edit', doc.id);
                            }
                        });
                    }
                    
                    const editBtn = document.getElementById(`edit-${doc.id}`);
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            navigate('edit', doc.id);
                        });
                    }

                    const quizBtn = document.getElementById(`quiz-${doc.id}`);
                    if (quizBtn) {
                        quizBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (doc.data().cards && doc.data().cards.length >= 4) {
                                navigate('quiz', doc.id);
                            } else {
                                alert("You need at least 4 cards in a set to start a quiz.");
                            }
                        });
                    }
                    
                    const learnBtn = document.getElementById(`learn-${doc.id}`);
                    if (learnBtn) {
                        learnBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (doc.data().cards && doc.data().cards.length > 0) {
                                navigate('learnSetup', doc.id);
                            } else {
                                alert("This set has no cards! Add cards to study.");
                                navigate('edit', doc.id);
                            }
                        });
                    }
                    
                    const card = document.getElementById(`card-${doc.id}`);
                    if (card) {
                        card.addEventListener('click', () => {
                            navigate('edit', doc.id);
                        });
                    }
                });

            }, (err) => {
                console.error("Error in dashboard listener:", err);
                if (setListContainer) {
                    setListContainer.innerHTML = `<p class="text-red-600">Error loading sets: ${err.message}</p>`;
                }
            });
        }

        function SetCardHTML(id, set) {
            const cardCount = set.cards ? set.cards.length : 0;
            const isOwner = set.ownerId === globalUser.uid;
            const ownerEmail = set.ownerEmail || 'A user';
            
            // This is for the search page, so we don't show edit buttons
            const isPublicSearch = !isOwner;
            
            return `
              <div
                id="card-${id}"
                class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl flex flex-col justify-between h-full ${isOwner ? 'cursor-pointer' : 'cursor-default'}"
              >
                <div class="p-6">
                  <div class="flex justify-between items-start">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">${set.title}</h3>
                     ${set.isPublic ? `
                        <div class="flex items-center text-xs text-green-600 dark:text-green-400 bg-green-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                          ${IconPublic()}
                          <span class="ml-1">Public</span>
                        </div>
                     ` : `
                        <div class="flex items-center text-xs text-red-600 dark:text-red-400 bg-red-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                          ${IconPrivate()}
                          <span class="ml-1">Private</span>
                        </div>
                     `}
                  </div>
                  <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-2">${set.description || "No description."}</p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    ${cardCount} ${cardCount === 1 ? 'card' : 'cards'}
                  </p>
                  ${isPublicSearch ? `
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                      Created by: ${ownerEmail}
                    </p>
                  ` : ''}
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 flex flex-wrap gap-2 justify-end">
                  ${isOwner ? `
                    <button
                      id="edit-${id}"
                      class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                    >
                      ${IconEdit()}
                      <span class="ml-2">Edit</span>
                    </button>
                  ` : ''}
                  
                  <button
                      id="learn-${id}"
                      ${cardCount === 0 ? 'disabled' : ''}
                      class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      ${IconLearn()}
                      <span class="ml-2">Learn</span>
                  </button>
                  
                  <button
                    id="quiz-${id}"
                    ${cardCount < 4 ? 'disabled' : ''}
                    class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="${cardCount < 4 ? 'Needs 4+ cards for a quiz' : 'Start Quiz'}"
                  >
                    ${IconQuiz()}
                    <span class="ml-2">Quiz</span>
                  </button>
                  
                  <button
                    id="study-${id}"
                    ${cardCount === 0 ? 'disabled' : ''}
                    class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    ${IconBook()}
                    <span class="ml-2">Study</span>
                  </button>
                </div>
              </div>
            `;
        }

        // --- SEARCH PAGE ---
        function SearchPageHTML() {
            return `
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Search Public Sets</h1>
                  <div class="mb-6">
                    <input
                      type="text"
                      id="search-input"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      placeholder="Search by title or description..."
                    />
                  </div>
                  <div id="search-results-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-700 dark:text-gray-300">Loading public sets...</p>
                  </div>
                </div>
            `;
        }
        
        function attachSearchListeners() {
            const searchInput = document.getElementById('search-input');
            const resultsList = document.getElementById('search-results-list');
            
            if (!searchInput) return;
            
            let allPublicSets = [];

            const setsCollection = collection(db, "studySets");
            const q = query(setsCollection, where("isPublic", "==", true));

            searchUnsubscribe = onSnapshot(q, (querySnapshot) => {
                // Add a check: only update if we are still on the search page
                if (currentPage !== 'search' || !document.getElementById('search-results-list')) {
                    console.log("Search listener fired, but not on search page. Ignoring.");
                    return;
                }
                
                allPublicSets = [];
                querySnapshot.forEach((doc) => {
                    allPublicSets.push({ id: doc.id, ...doc.data() });
                });
                renderSearchResults(allPublicSets);
            }, (err) => {
                console.error("Error in search listener:", err);
                if (resultsList) {
                    resultsList.innerHTML = `<p class="text-red-600">Error loading sets: ${err.message}</p>`;
                }
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.trim() === '') {
                    renderSearchResults(allPublicSets);
                    return;
                }
                const filteredSets = allPublicSets.filter(set => 
                    set.title.toLowerCase().includes(searchTerm) ||
                    set.description.toLowerCase().includes(searchTerm)
                );
                renderSearchResults(filteredSets, searchTerm);
            });

            // Helper to render results
            function renderSearchResults(sets, searchTerm = null) {
                // Check if we are still on the search page before rendering
                if (currentPage !== 'search') return;
                
                if (sets.length === 0) {
                    resultsList.innerHTML = `<p class="text-gray-600 dark:text-gray-400">
                        ${searchTerm ? `No sets found matching "${searchTerm}".` : 'No public sets available.'}
                    </p>`;
                    return;
                }
                
                let setsHTML = '';
                sets.forEach(set => {
                    setsHTML += SetCardHTML(set.id, set);
                });
                resultsList.innerHTML = setsHTML;
                
                // Add listeners for all the new cards
                sets.forEach(set => {
                    const studyBtn = document.getElementById(`study-${set.id}`);
                    if (studyBtn) {
                        studyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (set.cards && set.cards.length > 0) {
                                navigate('study', set.id);
                            } else {
                                alert("This set has no cards!");
                            }
                        });
                    }
                    
                    const quizBtn = document.getElementById(`quiz-${set.id}`);
                    if (quizBtn) {
                        quizBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (set.cards && set.cards.length >= 4) {
                                navigate('quiz', set.id);
                            } else {
                                alert("You need at least 4 cards in a set to start a quiz.");
                            }
                        });
                    }
                    
                    const learnBtn = document.getElementById(`learn-${set.id}`);
                    if (learnBtn) {
                        learnBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (set.cards && set.cards.length > 0) {
                                navigate('learnSetup', set.id);
                            } else {
                                alert("This set has no cards!");
                            }
                        });
                    }

                    const card = document.getElementById(`card-${set.id}`);
                    if (card) {
                        card.addEventListener('click', () => {
                            if (set.cards && set.cards.length > 0) {
                                navigate('study', set.id);
                            } else {
                                alert("This set has no cards!");
                            }
                        });
                    }
                });
            }
        }
        
        // --- SET EDITOR PAGE (Create & Edit) ---
        function SetEditorHTML(setId = null) {
            const isEditing = setId !== null;
            return `
                <div>
                  <button id="editor-back-btn" class="flex items-center text-blue-600 dark:text-blue-400 hover:underline mb-4">
                    ${IconBack()}
                    <span class="ml-1">Back to Dashboard</span>
                  </button>
                  
                  <form id="editor-form" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">${isEditing ? 'Edit Study Set' : 'Create New Study Set'}</h1>
                    
                    <!-- Loading State -->
                    <div id="editor-loading" class="hidden">
                        <p class="text-gray-700 dark:text-gray-300">Loading set editor...</p>
                    </div>

                    <!-- Error State -->
                    <div id="editor-error" class="hidden">
                        <p class="text-red-600"></p>
                    </div>
                    
                    <!-- Form Content -->
                    <div id="editor-content">
                        <div class="space-y-6">
                          <!-- Set Details -->
                          <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                            <input
                              type="text"
                              id="title"
                              required
                              class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="e.g. Biology - Chapter 1"
                            />
                          </div>
                          <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                            <textarea
                              id="description"
                              rows="3"
                              class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="A quick summary of what this set covers"
                            ></textarea>
                          </div>
                          
                          <!-- Privacy Toggle -->
                          <div class="flex items-center justify-between">
                            <span class="flex-grow flex flex-col">
                              <span class="text-sm font-medium text-gray-900 dark:text-white">Visibility</span>
                              <span id="privacy-label" class="text-sm text-gray-500 dark:text-gray-400">Only visible to you.</span>
                            </span>
                            <button
                              type="button"
                              id="privacy-toggle"
                              class="bg-gray-200 dark:bg-gray-700 relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
                            >
                              <span class="sr-only">Toggle Visibility</span>
                              <span
                                id="privacy-toggle-knob"
                                class="translate-x-1 inline-block w-4 h-4 transform bg-white dark:bg-gray-300 rounded-full transition-transform"
                              />
                            </button>
                          </div>

                          <!-- Cards Section -->
                          <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Flashcards</h2>
                            
                            <div id="cards-container" class="space-y-4">
                              <!-- Cards will be injected here by JS -->
                            </div>
                            
                            <button
                              type="button"
                              id="add-card-btn"
                              class="mt-4 inline-flex items-center px-4 py-2 border border-dashed border-gray-400 dark:border-gray-500 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                            >
                              ${IconPlus()}
                              <span class="ml-2">Add Card</span>
                            </button>
                          </div>
                        </div>

                        <p id="form-error" class="text-red-600 mt-4 hidden"></p>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center justify-between mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                          <div>
                            ${isEditing ? `
                              <button
                                type="button"
                                id="delete-set-btn"
                                class="text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                              >
                                Delete Set
                              </button>
                            ` : ''}
                          </div>
                          <button
                            type="submit"
                            id="submit-set-btn"
                            class="px-6 py-2 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                          >
                            ${isEditing ? 'Update Set' : 'Create Set'}
                          </button>
                        </div>
                    </div>
                  </form>
                  
                  <!-- Delete Confirmation Modal -->
                  <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                      <h3 class="text-lg font-medium text-gray-900 dark:text-white">Delete Study Set?</h3>
                      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Are you sure? This action cannot be undone.</p>
                      <div class="mt-6 flex justify-end space-x-3">
                        <button
                          type="button"
                          id="cancel-delete-btn"
                          class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
                        >
                          Cancel
                        </button>
                        <button
                          type="button"
                          id="confirm-delete-btn"
                          class="px-4 py-2 bg-red-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-red-700 disabled:opacity-50"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
            `;
        }
        
        function attachSetEditorListeners(setId = null) {
            const isEditing = setId !== null;
            let currentCards = [{ term: '', definition: '' }];
            let isPublic = false;

            // Get all elements
            const backBtn = document.getElementById('editor-back-btn');
            const editorForm = document.getElementById('editor-form');
            const loadingEl = document.getElementById('editor-loading');
            const errorEl = document.getElementById('editor-error');
            const contentEl = document.getElementById('editor-content');
            
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            
            const privacyToggle = document.getElementById('privacy-toggle');
            const privacyToggleKnob = document.getElementById('privacy-toggle-knob');
            const privacyLabel = document.getElementById('privacy-label');
            
            const cardsContainer = document.getElementById('cards-container');
            const addCardBtn = document.getElementById('add-card-btn');
            const formError = document.getElementById('form-error');
            
            const submitBtn = document.getElementById('submit-set-btn');
            const deleteBtn = document.getElementById('delete-set-btn');
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // --- Helper function to render cards ---
            function renderCards() {
                cardsContainer.innerHTML = '';
                currentCards.forEach((card, index) => {
                    cardsContainer.innerHTML += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg" id="card-${index}">
                          <div>
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Term</label>
                            <input
                              type="text"
                              value="${card.term.replace(/"/g, '&quot;')}"
                              class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="Term"
                              data-index="${index}"
                              data-field="term"
                            />
                          </div>
                          <div class="flex">
                            <div class="flex-grow">
                              <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Definition</label>
                              <input
                                type="text"
                                value="${card.definition.replace(/"/g, '&quot;')}"
                                class="w-full px-3 py-2 mt-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Definition"
                                data-index="${index}"
                                data-field="definition"
                              />
                            </div>
                            <button
                              type="button"
                              data-index="${index}"
                              class="remove-card-btn ml-2 mt-6 p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-gray-700 rounded-full h-10 w-10 flex items-center justify-center"
                              title="Delete card"
                            >
                              ${IconTrash()}
                            </button>
                          </div>
                        </div>
                    `;
                });
                
                // Re-attach listeners for inputs and remove buttons
                cardsContainer.querySelectorAll('input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const { index, field } = e.target.dataset;
                        currentCards[index][field] = e.target.value;
                    });
                });
                
                cardsContainer.querySelectorAll('.remove-card-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (currentCards.length <= 1) {
                            alert("You must have at least one card.");
                            return;
                        }
                        const index = parseInt(e.currentTarget.dataset.index, 10);
                        currentCards = currentCards.filter((_, i) => i !== index);
                        renderCards(); // Re-render the cards list
                    });
                });
            }

            // --- Helper function to toggle privacy ---
            function togglePrivacy() {
                isPublic = !isPublic;
                if (isPublic) {
                    privacyToggle.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    privacyToggle.classList.add('bg-blue-600', 'dark:bg-blue-500');
                    privacyToggleKnob.classList.remove('translate-x-1');
                    privacyToggleKnob.classList.add('translate-x-6');
                    privacyLabel.textContent = "Visible to everyone.";
                } else {
                    privacyToggle.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    privacyToggle.classList.remove('bg-blue-600', 'dark:bg-blue-500');
                    privacyToggleKnob.classList.add('translate-x-1');
                    privacyToggleKnob.classList.remove('translate-x-6');
                    privacyLabel.textContent = "Only visible to you.";
                }
            }

            // --- Load data if editing ---
            if (isEditing) {
                loadingEl.style.display = 'block';
                contentEl.style.display = 'none';
                
                const fetchSet = async () => {
                    try {
                      const docRef = doc(db, "studySets", setId);
                      const docSnap = await getDoc(docRef);
                      if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.ownerId !== globalUser.uid) {
                          throw new Error("You don't have permission to edit this set.");
                        }
                        titleInput.value = data.title;
                        descriptionInput.value = data.description || '';
                        if (data.isPublic) {
                            togglePrivacy(); // Set to public
                        }
                        currentCards = data.cards.length > 0 ? data.cards : [{ term: '', definition: '' }];
                        renderCards();
                      } else {
                        throw new Error("Study set not found.");
                      }
                    } catch (err) {
                        console.error("Error fetching set:", err);
                        errorEl.textContent = "Failed to load study set: " + err.message;
                        errorEl.style.display = 'block';
                    } finally {
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                    }
                };
                fetchSet();
            } else {
                renderCards(); // Render the initial empty card
            }

            // --- Attach Listeners ---
            backBtn.addEventListener('click', () => navigate('dashboard'));
            privacyToggle.addEventListener('click', togglePrivacy);
            addCardBtn.addEventListener('click', () => {
                currentCards.push({ term: '', definition: '' });
                renderCards();
            });
            
            // Handle form submission
            editorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                formError.classList.add('hidden');

                const finalCards = currentCards.filter(card => card.term.trim() !== '' && card.definition.trim() !== '');

                if (finalCards.length === 0) {
                    formError.textContent = "You must have at least one valid card with a term and definition.";
                    formError.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEditing ? 'Update Set' : 'Create Set';
                    return;
                }

                const setData = {
                  title: titleInput.value.trim(),
                  description: descriptionInput.value.trim(),
                  isPublic,
                  ownerId: globalUser.uid,
                  ownerEmail: globalUser.email,
                  cards: finalCards,
                  updatedAt: serverTimestamp(),
                };

                try {
                  if (isEditing) {
                    const docRef = doc(db, "studySets", setId);
                    await updateDoc(docRef, setData);
                  } else {
                    setData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "studySets"), setData);
                  }
                  navigate('dashboard');
                } catch (err) {
                  console.error("Error saving set:", err);
                  formError.textContent = "Failed to save set: " + err.message;
                  formError.classList.remove('hidden');
                  submitBtn.disabled = false;
                  submitBtn.textContent = isEditing ? 'Update Set' : 'Create Set';
                }
            });
            
            // Modal listeners (if they exist)
            if (isEditing) {
                deleteBtn.addEventListener('click', () => deleteModal.classList.remove('hidden'));
                cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
                confirmDeleteBtn.addEventListener('click', async () => {
                    confirmDeleteBtn.disabled = true;
                    confirmDeleteBtn.textContent = 'Deleting...';
                    try {
                      const docRef = doc(db, "studySets", setId);
                      await deleteDoc(docRef);
                      navigate('dashboard');
                    } catch (err) {
                      console.error("Error deleting set:", err);
                      formError.textContent = "Failed to delete set: " + err.message;
                      formError.classList.remove('hidden');
                      confirmDeleteBtn.disabled = false;
                      confirmDeleteBtn.textContent = 'Delete';
                      deleteModal.classList.add('hidden');
                    }
                });
            }
        }
        
        // --- STUDY PAGE (Flashcards) ---
        function StudyPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto">
                    <button id="study-back-btn" class="flex items-center text-blue-600 dark:text-blue-400 hover:underline mb-4">
                        ${IconBack()}
                        <span class="ml-1">Back to Dashboard</span>
                    </button>
                    
                    <div id="study-content">
                        <!-- Loading State -->
                        <div id="study-loading">
                            <p class="text-gray-700 dark:text-gray-300">Loading study set...</p>
                        </div>
                        
                        <!-- Error State -->
                        <div id="study-error" class="hidden">
                            <p class="text-red-600"></p>
                        </div>
                        
                        <!-- Main Content -->
                        <div id="study-main" class="hidden">
                            <h1 id="study-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-2"></h1>
                            <p id="study-progress" class="text-lg text-gray-600 dark:text-gray-400 mb-6"></p>

                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-6">
                              <div id="study-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            
                            <!-- Flashcard -->
                            <div id="flashcard-flipper" class="card-flipper w-full h-96 mb-6">
                                <div id="flashcard-inner" class="card-inner relative w-full h-full">
                                  <!-- Front of Card (Term) -->
                                  <div class="card-front absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6">
                                    <p id="card-term" class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white text-center"></p>
                                  </div>
                                  <!-- Back of Card (Definition) -->
                                  <div class="card-back absolute w-full h-full bg-white dark:bg-gray-800 rounded-lg shadow-xl flex items-center justify-center p-6">
                                    <p id="card-definition" class="text-2xl md:text-3xl font-medium text-gray-800 dark:text-gray-300 text-center"></p>
                                  </div>
                                </div>
                            </div>
                            
                            <div class="text-center text-gray-500 dark:text-gray-400 text-sm mb-6">Click card to flip</div>

                            <!-- Navigation Controls -->
                            <div class="flex items-center justify-between mb-6">
                              <button id="card-prev-btn" class="p-4 rounded-full bg-white dark:bg-gray-800 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Previous Card">
                                ${IconPrev()}
                              </button>
                              
                              <button id="card-flip-btn" class="flex items-center px-6 py-3 rounded-lg bg-white dark:bg-gray-800 shadow-md font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="Flip Card">
                                ${IconFlip()}
                                <span class="ml-2">Flip</span>
                              </button>
                              
                              <button id="card-next-btn" class="p-4 rounded-full bg-white dark:bg-gray-800 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Next Card">
                                ${IconNext()}
                              </button>
                            </div>
                            
                            <!-- Known/Unknown Button -->
                             <button id="card-known-btn" class="w-full py-4 rounded-lg font-bold text-lg transition-colors bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900 dark:text-green-300 dark:hover:bg-green-800">
                                Mark as Known
                              </button>
                        </div>
                    </div>
                    
                    <!-- Completion Modal -->
                    <div id="study-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                      <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                        <div id="confetti-container" class="absolute top-0 left-0 w-full h-full"></div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Set Complete!</h3>
                        <p id="study-complete-message" class="mt-4 text-lg text-gray-600 dark:text-gray-400"></p>
                        <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                          <button
                            type="button"
                            id="study-restart-btn"
                            class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                          >
                            Study Again
                          </button>
                          <button
                            type="button"
                            id="study-complete-back-btn"
                            class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
                          >
                            Back to Dashboard
                          </button>
                        </div>
                      </div>
                    </div>

                </div>
            `;
        }
        
        function attachStudyListeners(setId) {
            let currentSet = null;
            let currentIndex = 0;
            let isFlipped = false;
            let knownCards = new Set();
            
            // Get all elements
            const backBtn = document.getElementById('study-back-btn');
            const loadingEl = document.getElementById('study-loading');
            const errorEl = document.getElementById('study-error');
            const mainEl = document.getElementById('study-main');
            
            const titleEl = document.getElementById('study-title');
            const progressEl = document.getElementById('study-progress');
            const progressBar = document.getElementById('study-progress-bar');
            
            const flipper = document.getElementById('flashcard-flipper');
            const flipperInner = document.getElementById('flashcard-inner');
            const termEl = document.getElementById('card-term');
            const definitionEl = document.getElementById('card-definition');
            
            const prevBtn = document.getElementById('card-prev-btn');
            const flipBtn = document.getElementById('card-flip-btn');
            const nextBtn = document.getElementById('card-next-btn');
            const knownBtn = document.getElementById('card-known-btn');
            
            const completeModal = document.getElementById('study-complete-modal');
            const completeMsg = document.getElementById('study-complete-message');
            const restartBtn = document.getElementById('study-restart-btn');
            const completeBackBtn = document.getElementById('study-complete-back-btn');

            function showCard(index) {
                const card = currentSet.cards[index];
                termEl.textContent = card.term;
                definitionEl.textContent = card.definition;
                progressEl.textContent = `${index + 1} / ${currentSet.cards.length}`;
                
                if (knownCards.has(card.term)) {
                    knownBtn.textContent = 'Mark as Unknown';
                    knownBtn.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200', 'dark:bg-green-900', 'dark:text-green-300', 'dark:hover:bg-green-800');
                    knownBtn.classList.add('bg-red-100', 'text-red-700', 'hover:bg-red-200', 'dark:bg-red-900', 'dark:text-red-300', 'dark:hover:bg-red-800');
                } else {
                    knownBtn.textContent = 'Mark as Known';
                    knownBtn.classList.add('bg-green-100', 'text-green-700', 'hover:bg-green-200', 'dark:bg-green-900', 'dark:text-green-300', 'dark:hover:bg-green-800');
                    knownBtn.classList.remove('bg-red-100', 'text-red-700', 'hover:bg-red-200', 'dark:bg-red-900', 'dark:text-red-300', 'dark:hover:bg-red-800');
                }
                
                const progressPercent = (knownCards.size / currentSet.cards.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }

            function doFlip() {
                isFlipped = !isFlipped;
                if (isFlipped) {
                    flipper.classList.add('card-flipped'); // FIX: Apply to the parent flipper
                } else {
                    flipper.classList.remove('card-flipped'); // FIX: Apply to the parent flipper
                }
            }

            function doNextCard() {
                if (isFlipped) doFlip();
                
                setTimeout(() => {
                  if (currentIndex < currentSet.cards.length - 1) {
                    currentIndex++;
                    showCard(currentIndex);
                  } else {
                    // Reached end, check for completion
                    if (knownCards.size === currentSet.cards.length) {
                        completeMsg.textContent = `You've marked all ${currentSet.cards.length} cards as known.`;
                        completeModal.classList.remove('hidden');
                        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    } else {
                        currentIndex = 0; // Loop back to start
                        showCard(currentIndex);
                    }
                  }
                }, 150); // Small delay to allow CSS to reset
            }

            function doPrevCard() {
                if (isFlipped) doFlip();
                setTimeout(() => {
                  if (currentIndex > 0) {
                    currentIndex--;
                  } else {
                    currentIndex = currentSet.cards.length - 1; // Loop to end
                  }
                  showCard(currentIndex);
                }, 150);
            }

            function toggleKnown() {
                const cardKey = currentSet.cards[currentIndex].term;
                if (knownCards.has(cardKey)) {
                    knownCards.delete(cardKey);
                } else {
                    knownCards.add(cardKey);
                }
                
                if (knownCards.has(cardKey)) {
                    doNextCard();
                } else {
                    showCard(currentIndex); // Just update the button
                }
            }
            
            function doRestart() {
                currentIndex = 0;
                isFlipped = false;
                knownCards = new Set();
                completeModal.classList.add('hidden');
                showCard(currentIndex);
            }

            // --- Load data ---
            const fetchSet = async () => {
                try {
                  const docRef = doc(db, "studySets", setId);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    currentSet = { id: docSnap.id, ...docSnap.data() };
                    titleEl.textContent = currentSet.title;
                    showCard(0);
                    mainEl.classList.remove('hidden');
                  } else {
                    throw new Error("Study set not found.");
                  }
                } catch (err) {
                  console.error("Error fetching set:", err);
                  errorEl.textContent = "Failed to load study set: " + err.message;
                  errorEl.classList.remove('hidden');
                } finally {
                  loadingEl.classList.add('hidden');
                }
            };
            fetchSet();

            // --- Attach Listeners ---
            backBtn.addEventListener('click', () => navigate('dashboard'));
            flipper.addEventListener('click', doFlip);
            flipBtn.addEventListener('click', doFlip);
            prevBtn.addEventListener('click', doPrevCard);
            nextBtn.addEventListener('click', doNextCard);
            knownBtn.addEventListener('click', toggleKnown);
            
            restartBtn.addEventListener('click', doRestart);
            completeBackBtn.addEventListener('click', () => navigate('dashboard'));
        }
        
        // --- QUIZ PAGE ---
        function QuizPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto">
                    <button id="quiz-back-btn" class="flex items-center text-blue-600 dark:text-blue-400 hover:underline mb-4">
                        ${IconBack()}
                        <span class="ml-1">Back to Dashboard</span>
                    </button>
                    
                    <div id="quiz-content">
                        <!-- Loading State -->
                        <div id="quiz-loading">
                            <p class="text-gray-700 dark:text-gray-300">Loading quiz...</p>
                        </div>
                        
                        <!-- Error State -->
                        <div id="quiz-error" class="hidden">
                            <p class="text-red-600"></p>
                        </div>
                        
                        <!-- Main Content -->
                        <div id="quiz-main" class="hidden">
                            <h1 id="quiz-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-2"></h1>
                            <div class="flex justify-between items-center mb-6">
                                <p id="quiz-progress" class="text-lg text-gray-600 dark:text-gray-400"></p>
                                <p id="quiz-score" class="text-lg font-semibold text-gray-800 dark:text-white"></p>
                            </div>
                            
                            <!-- Question Card -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-8 min-h-[150px] flex items-center justify-center">
                                <p id="quiz-question" class="text-2xl md:text-3xl font-semibold text-gray-900 dark:text-white text-center"></p>
                            </div>
                            
                            <!-- Options -->
                            <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Options will be injected by JS -->
                            </div>
                            
                            <!-- Feedback & Next Button -->
                            <div id="quiz-feedback" class="mt-6 hidden">
                                <p id="feedback-text" class="text-xl font-medium"></p>
                                <button id="next-question-btn" class="mt-4 w-full px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Completion Modal -->
                    <div id="quiz-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                      <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                        <div id="confetti-container-quiz" class="absolute top-0 left-0 w-full h-full"></div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Quiz Complete!</h3>
                        <p class="mt-4 text-3xl font-bold" id="quiz-final-score"></p>
                        <p class="mt-2 text-lg text-gray-600 dark:text-gray-400" id="quiz-final-message"></p>
                        <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                          <button
                            type="button"
                            id="quiz-restart-btn"
                            class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                          >
                            Try Again
                          </button>
                          <button
                            type="button"
                            id="quiz-complete-back-btn"
                            class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
                          >
                            Back to Dashboard
                          </button>
                        </div>
                      </div>
                    </div>
                </div>
            `;
        }
        
        function attachQuizListeners(setId) {
            let currentSet = null;
            let questions = []; // Array of { term, definition, options }
            let currentIndex = 0;
            let score = 0;
            
            // Get all elements
            const backBtn = document.getElementById('quiz-back-btn');
            const loadingEl = document.getElementById('quiz-loading');
            const errorEl = document.getElementById('quiz-error');
            const mainEl = document.getElementById('quiz-main');
            
            const titleEl = document.getElementById('quiz-title');
            const progressEl = document.getElementById('quiz-progress');
            const scoreEl = document.getElementById('quiz-score');
            const questionEl = document.getElementById('quiz-question');
            const optionsEl = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            const feedbackText = document.getElementById('feedback-text');
            const nextBtn = document.getElementById('next-question-btn');
            
            const completeModal = document.getElementById('quiz-complete-modal');
            const finalScoreEl = document.getElementById('quiz-final-score');
            const finalMsgEl = document.getElementById('quiz-final-message');
            const restartBtn = document.getElementById('quiz-restart-btn');
            const completeBackBtn = document.getElementById('quiz-complete-back-btn');

            // --- Helper: Shuffle array
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- Helper: Generate quiz questions
            function generateQuestions(cards) {
                const shuffledCards = shuffleArray([...cards]);
                return shuffledCards.map((card) => {
                    const { term, definition } = card;
                    
                    // Get 3 wrong definitions
                    const wrongOptions = cards
                        .filter(c => c.definition !== definition) // Find all different cards
                        .sort(() => 0.5 - Math.random()) // Shuffle them
                        .slice(0, 3) // Get the first 3
                        .map(c => c.definition); // Get their definitions
                    
                    const options = shuffleArray([...wrongOptions, definition]);
                    
                    return {
                        term,
                        definition,
                        options
                    };
                });
            }

            // --- Helper: Display current question
            function showQuestion(index) {
                const q = questions[index];
                questionEl.textContent = q.term;
                progressEl.textContent = `Question ${index + 1} / ${questions.length}`;
                scoreEl.textContent = `Score: ${score}`;
                optionsEl.innerHTML = '';
                
                q.options.forEach((option, i) => {
                    optionsEl.innerHTML += `
                        <button
                            data-option="${option}"
                            class="option-btn block w-full text-left p-5 bg-white dark:bg-gray-700 rounded-lg shadow-md hover:shadow-lg hover:bg-blue-50 dark:hover:bg-gray-600 transition-all"
                        >
                            <span class="text-gray-800 dark:text-gray-200">${option}</span>
                        </button>
                    `;
                });
                
                // Add listeners to new option buttons
                optionsEl.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', handleOptionClick);
                });
            }

            // --- Helper: Handle user answer
            function handleOptionClick(e) {
                const selectedOption = e.currentTarget.dataset.option;
                const correctAnswer = questions[currentIndex].definition;
                
                // Disable all buttons
                optionsEl.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.option === correctAnswer) {
                        btn.classList.add('bg-green-200', 'dark:bg-green-800');
                    }
                });
                
                if (selectedOption === correctAnswer) {
                    score++;
                    feedbackText.textContent = 'Correct!';
                    feedbackText.className = 'text-xl font-medium text-green-600 dark:text-green-400';
                } else {
                    e.currentTarget.classList.add('bg-red-200', 'dark:bg-red-800');
                    feedbackText.textContent = 'Incorrect!';
                    feedbackText.className = 'text-xl font-medium text-red-600 dark:text-red-400';
                }
                
                scoreEl.textContent = `Score: ${score}`;
                feedbackEl.classList.remove('hidden');
            }

            // --- Helper: Go to next question or finish
            function nextQuestion() {
                currentIndex++;
                if (currentIndex < questions.length) {
                    feedbackEl.classList.add('hidden');
                    showQuestion(currentIndex);
                } else {
                    // Quiz complete
                    showResults();
                }
            }
            
            // --- Helper: Show final results
            function showResults() {
                const percentage = Math.round((score / questions.length) * 100);
                finalScoreEl.textContent = `${percentage}%`;
                finalMsgEl.textContent = `You got ${score} out of ${questions.length} correct.`;
                completeModal.classList.remove('hidden');
                
                if (percentage === 100) {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }
            }
            
            // --- Helper: Restart quiz
            function restartQuiz() {
                questions = shuffleArray(questions);
                currentIndex = 0;
                score = 0;
                feedbackEl.classList.add('hidden');
                completeModal.classList.add('hidden');
                showQuestion(0);
            }

            // --- Load data ---
            const fetchSet = async () => {
                try {
                  const docRef = doc(db, "studySets", setId);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    currentSet = { id: docSnap.id, ...docSnap.data() };
                    
                    if (currentSet.cards.length < 4) {
                        throw new Error("This set must have at least 4 cards to be quizzed.");
                    }
                    
                    questions = generateQuestions(currentSet.cards);
                    titleEl.textContent = currentSet.title;
                    mainEl.classList.remove('hidden');
                    restartQuiz();
                  } else {
                    throw new Error("Study set not found.");
                  }
                } catch (err) {
                  console.error("Error fetching set:", err);
                  errorEl.textContent = "Failed to load quiz: " + err.message;
                  errorEl.classList.remove('hidden');
                } finally {
                  loadingEl.classList.add('hidden');
                }
            };
            fetchSet();
            
            // --- Attach Listeners ---
            backBtn.addEventListener('click', () => navigate('dashboard'));
            nextBtn.addEventListener('click', nextQuestion);
            restartBtn.addEventListener('click', restartQuiz);
            completeBackBtn.addEventListener('click', () => navigate('dashboard'));
        }
        
        // --- LEARN SETUP PAGE ---
        function LearnSetupPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto">
                    <button id="learn-setup-back-btn" class="flex items-center text-blue-600 dark:text-blue-400 hover:underline mb-4">
                        ${IconBack()}
                        <span class="ml-1">Back to Dashboard</span>
                    </button>
                    
                    <div id="learn-setup-content" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl">
                        <!-- Loading State -->
                        <div id="learn-setup-loading">
                            <p class="text-gray-700 dark:text-gray-300">Loading settings...</p>
                        </div>
                        
                        <!-- Error State -->
                        <div id="learn-setup-error" class="hidden">
                            <p class="text-red-600"></p>
                        </div>
                        
                        <!-- Main Content -->
                        <div id="learn-setup-main" class="hidden">
                            <h1 id="learn-setup-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Learn Setup</h1>
                            
                            <form id="learn-setup-form" class="space-y-8">
                                <!-- Session Size -->
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Session Size</h2>
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <label class="flex-1 p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="radio" name="session-size" value="10" class="mr-2">
                                            <span class="text-gray-700 dark:text-gray-300">10 Cards</span>
                                        </label>
                                        <label class="flex-1 p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="radio" name="session-size" value="20" class="mr-2">
                                            <span class="text-gray-700 dark:text-gray-300">20 Cards</span>
                                        </label>
                                        <label class="flex-1 p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="radio" name="session-size" value="all" class="mr-2" checked>
                                            <span class="text-gray-700 dark:text-gray-300">All Cards (<span id="learn-card-count">0</span>)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Question Types -->
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Question Types</h2>
                                    <div class="space-y-4">
                                        <label class="flex items-center p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="checkbox" id="q-type-mc" value="mc" class="h-5 w-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500" checked>
                                            <span class="ml-3 text-gray-700 dark:text-gray-300">Multiple Choice (Easier)</span>
                                        </label>
                                        <label class="flex items-center p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="checkbox" id="q-type-typed" value="typed" class="h-5 w-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
                                            <span class="ml-3 text-gray-700 dark:text-gray-300">Typed Answer (Harder)</span>
                                        </label>
                                    </div>
                                    <p id="q-type-error" class="text-red-600 text-sm mt-2 hidden">Please select at least one question type.</p>
                                </div>
                                
                                <!-- Prompt Direction -->
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Prompt With...</h2>
                                    <div class="space-y-4">
                                        <label class="flex items-center p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="checkbox" id="prompt-term" value="term" class="h-5 w-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500" checked>
                                            <span class="ml-3 text-gray-700 dark:text-gray-300">Term (Show "Mitochondria", ask for definition)</span>
                                        </label>
                                        <label class="flex items-center p-4 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="checkbox" id="prompt-def" value="def" class="h-5 w-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500" checked>
                                            <span class="ml-3 text-gray-700 dark:text-gray-300">Definition (Show "Powerhouse of the cell", ask for term)</span>
                                        </label>
                                    </div>
                                    <p id="prompt-error" class="text-red-600 text-sm mt-2 hidden">Please select at least one prompt direction.</p>
                                </div>
                                
                                <button type="submit" class="w-full px-6 py-3 text-lg font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                                    Start Learning
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function attachLearnSetupListeners(setId) {
            let cardCount = 0;
            
            // Get all elements
            const backBtn = document.getElementById('learn-setup-back-btn');
            const loadingEl = document.getElementById('learn-setup-loading');
            const errorEl = document.getElementById('learn-setup-error');
            const mainEl = document.getElementById('learn-setup-main');
            
            const titleEl = document.getElementById('learn-setup-title');
            const cardCountEl = document.getElementById('learn-card-count');
            const form = document.getElementById('learn-setup-form');
            
            const qTypeMC = document.getElementById('q-type-mc');
            const qTypeTyped = document.getElementById('q-type-typed');
            const qTypeError = document.getElementById('q-type-error');
            
            const promptTerm = document.getElementById('prompt-term');
            const promptDef = document.getElementById('prompt-def');
            const promptError = document.getElementById('prompt-error');
            
            // --- Load data ---
            const fetchSet = async () => {
                try {
                  const docRef = doc(db, "studySets", setId);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    const set = { id: docSnap.id, ...docSnap.data() };
                    cardCount = set.cards.length;
                    titleEl.textContent = `Learn: ${set.title}`;
                    cardCountEl.textContent = cardCount;
                    mainEl.classList.remove('hidden');
                  } else {
                    throw new Error("Study set not found.");
                  }
                } catch (err) {
                  console.error("Error fetching set:", err);
                  errorEl.textContent = "Failed to load settings: " + err.message;
                  errorEl.classList.remove('hidden');
                } finally {
                  loadingEl.classList.add('hidden');
                }
            };
            fetchSet();
            
            // --- Attach Listeners ---
            backBtn.addEventListener('click', () => navigate('dashboard'));
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Validation
                const qTypes = [qTypeMC.checked, qTypeTyped.checked];
                const prompts = [promptTerm.checked, promptDef.checked];
                
                let isValid = true;
                if (!qTypes.some(v => v)) {
                    qTypeError.classList.remove('hidden');
                    isValid = false;
                } else {
                    qTypeError.classList.add('hidden');
                }
                
                if (!prompts.some(v => v)) {
                    promptError.classList.remove('hidden');
                    isValid = false;
                } else {
                    promptError.classList.add('hidden');
                }
                
                if (!isValid) return;
                
                // Save settings
                learnSettings = {
                    sessionSize: document.querySelector('input[name="session-size"]:checked').value,
                    qTypeMC: qTypeMC.checked,
                    qTypeTyped: qTypeTyped.checked,
                    promptTerm: promptTerm.checked,
                    promptDef: promptDef.checked,
                    allCards: cardCount // Store total card count
                };
                
                // Navigate to learn session
                navigate('learn', setId);
            });
        }
        
        // --- LEARN SESSION PAGE ---
        function LearnPageHTML(setId) {
            return `
                <div class="max-w-3xl mx-auto">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <button id="learn-back-btn" class="flex items-center text-blue-600 dark:text-blue-400 hover:underline">
                            ${IconBack()}
                            <span class="ml-1">Back to Setup</span>
                        </button>
                        <h1 id="learn-title" class="text-2xl font-bold text-gray-900 dark:text-white">Learn</h1>
                    </div>
                    
                    <!-- Progress Stats -->
                    <div class="flex justify-around bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6">
                        <div class="text-center">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Remaining</div>
                            <div id="stat-remaining" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Incorrect</div>
                            <div id="stat-incorrect" class="text-2xl font-bold text-red-600 dark:text-red-400">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Correct</div>
                            <div id="stat-correct" class="text-2xl font-bold text-green-600 dark:text-green-400">0</div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div id="learn-content">
                        <!-- Loading State -->
                        <div id="learn-loading">
                            <p class="text-gray-700 dark:text-gray-300">Building your session...</p>
                        </div>
                        
                        <!-- Error State -->
                        <div id="learn-error" class="hidden">
                            <p class="text-red-600"></p>
                        </div>
                        
                        <!-- Question Card -->
                        <div id="learn-question-card" class="hidden">
                            <!-- Prompt -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-6">
                                <p class="text-sm text-gray-500 dark:text-gray-400" id="question-prompt-label">DEFINITION</p>
                                <p id="question-prompt" class="text-2xl md:text-3xl font-semibold text-gray-900 dark:text-white mt-2 min-h-[50px]"></p>
                            </div>
                            
                            <!-- Answer Area (MC) -->
                            <div id="answer-mc" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- MC options injected here -->
                            </div>
                            
                            <!-- Answer Area (Typed) -->
                            <form id="answer-typed" class="hidden">
                                <label for="typed-answer" class="text-sm text-gray-500 dark:text-gray-400" id="answer-prompt-label">TERM</label>
                                <input
                                  type="text"
                                  id="typed-answer"
                                  autocomplete="off"
                                  class="w-full px-4 py-3 mt-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-lg"
                                />
                                <button type="submit" class="mt-4 w-full px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                    Check Answer
                                </button>
                            </form>
                        </div>
                        
                        <!-- Feedback Card -->
                        <div id="learn-feedback-card" class="hidden">
                            <div id="feedback-box" class="p-6 rounded-lg shadow-xl">
                                <h2 id="feedback-title" class="text-2xl font-bold"></h2>
                                <p id="feedback-correct-answer" class="text-lg mt-2 dark:text-gray-300"></p>
                            </div>
                            <button id="feedback-next-btn" class="mt-6 w-full px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                Continue
                            </button>
                        </div>
                    </div>
                    
                    <!-- Completion Modal -->
                    <div id="learn-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                      <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                        <div id="confetti-container-learn" class="absolute top-0 left-0 w-full h-full"></div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Session Complete!</h3>
                        <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">Great job! You've mastered all the cards in this session.</p>
                        <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                          <button
                            type="button"
                            id="learn-restart-btn"
                            class="px-6 py-3 bg-blue-600 border border-transparent rounded-md text-base font-medium text-white hover:bg-blue-700"
                          >
                            Start New Session
                          </button>
                          <button
                            type="button"
                            id="learn-complete-back-btn"
                            class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
                          >
                            Back to Dashboard
                          </button>
                        </div>
                      </div>
                    </div>
                </div>
            `;
        }
        
        function attachLearnListeners(setId) {
            // State
            let allCards = [];
            let sessionQueue = []; // Cards to be asked
            let incorrectQueue = []; // Cards gotten wrong
            let correctCount = 0;
            let currentQuestion = null; // { card, prompt, answer, type }
            
            // Get all elements
            const backBtn = document.getElementById('learn-back-btn');
            const titleEl = document.getElementById('learn-title');
            const statRemaining = document.getElementById('stat-remaining');
            const statIncorrect = document.getElementById('stat-incorrect');
            const statCorrect = document.getElementById('stat-correct');
            
            const loadingEl = document.getElementById('learn-loading');
            const errorEl = document.getElementById('learn-error');
            
            const questionCard = document.getElementById('learn-question-card');
            const promptLabel = document.getElementById('question-prompt-label');
            const promptText = document.getElementById('question-prompt');
            
            const mcArea = document.getElementById('answer-mc');
            const typedArea = document.getElementById('answer-typed');
            const typedInput = document.getElementById('typed-answer');
            const typedLabel = document.getElementById('answer-prompt-label');
            
            const feedbackCard = document.getElementById('learn-feedback-card');
            const feedbackBox = document.getElementById('feedback-box');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackAnswer = document.getElementById('feedback-correct-answer');
            const feedbackNextBtn = document.getElementById('feedback-next-btn');
            
            const completeModal = document.getElementById('learn-complete-modal');
            const restartBtn = document.getElementById('learn-restart-btn');
            const completeBackBtn = document.getElementById('learn-complete-back-btn');

            // --- Helper: Shuffle array
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // --- Helper: Update stats UI
            function updateStats() {
                statRemaining.textContent = sessionQueue.length;
                statIncorrect.textContent = incorrectQueue.length;
                statCorrect.textContent = correctCount;
            }

            // --- Helper: Build the initial session queue
            function buildSession(cards) {
                let sessionCards = shuffleArray([...cards]);
                if (learnSettings.sessionSize !== 'all') {
                    sessionCards = sessionCards.slice(0, parseInt(learnSettings.sessionSize));
                }
                
                // Create questions based on prompt settings
                sessionQueue = [];
                sessionCards.forEach(card => {
                    if (learnSettings.promptTerm) sessionQueue.push({ card, prompt: 'term', answer: 'def' });
                    if (learnSettings.promptDef) sessionQueue.push({ card, prompt: 'def', answer: 'term' });
                });
                
                sessionQueue = shuffleArray(sessionQueue);
                incorrectQueue = [];
                correctCount = 0;
            }
            
            // --- Helper: Get the next question
            function nextQuestion() {
                if (sessionQueue.length === 0 && incorrectQueue.length === 0) {
                    // Session Complete!
                    completeModal.classList.remove('hidden');
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    return;
                }
                
                // Prioritize incorrect cards, but mix them up
                if (incorrectQueue.length > 0 && (sessionQueue.length === 0 || Math.random() < 0.5)) {
                    currentQuestion = incorrectQueue.shift();
                } else {
                    currentQuestion = sessionQueue.shift();
                }
                
                // Decide question type (MC or Typed)
                const availableTypes = [];
                if (learnSettings.qTypeMC) availableTypes.push('mc');
                if (learnSettings.qTypeTyped) availableTypes.push('typed');
                
                currentQuestion.type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                
                displayQuestion();
            }

            // --- Helper: Display the current question
            function displayQuestion() {
                updateStats();
                
                // Set prompt
                if (currentQuestion.prompt === 'term') {
                    promptLabel.textContent = "TERM";
                    promptText.textContent = currentQuestion.card.term;
                } else {
                    promptLabel.textContent = "DEFINITION";
                    promptText.textContent = currentQuestion.card.definition;
                }
                
                // Show correct answer area
                if (currentQuestion.type === 'mc') {
                    // --- Build Multiple Choice ---
                    mcArea.classList.remove('hidden');
                    typedArea.classList.add('hidden');
                    mcArea.innerHTML = '';
                    
                    const correctAnswer = currentQuestion.card[currentQuestion.answer === 'term' ? 'term' : 'definition'];
                    
                    // Get 3 wrong options
                    const wrongOptions = allCards
                        .filter(c => c[currentQuestion.answer === 'term' ? 'term' : 'definition'] !== correctAnswer)
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 3)
                        .map(c => c[currentQuestion.answer === 'term' ? 'term' : 'definition']);
                    
                    const options = shuffleArray([...wrongOptions, correctAnswer]);
                    
                    options.forEach(option => {
                        mcArea.innerHTML += `
                            <button
                                data-option="${option.replace(/"/g, '&quot;')}"
                                class="mc-option-btn block w-full text-left p-5 bg-white dark:bg-gray-700 rounded-lg shadow-md hover:shadow-lg hover:bg-blue-50 dark:hover:bg-gray-600 transition-all"
                            >
                                <span class="text-gray-800 dark:text-gray-200">${option}</span>
                            </button>
                        `;
                    });
                    
                    mcArea.querySelectorAll('.mc-option-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => checkAnswer(e.currentTarget.dataset.option));
                    });

                } else {
                    // --- Build Typed Answer ---
                    mcArea.classList.add('hidden');
                    typedArea.classList.remove('hidden');
                    typedInput.value = '';
                    typedLabel.textContent = currentQuestion.answer === 'term' ? 'TERM' : 'DEFINITION';
                    typedInput.focus();
                }
                
                // Show question, hide feedback
                questionCard.classList.remove('hidden');
                feedbackCard.classList.add('hidden');
            }
            
            // --- Helper: Check the user's answer
            function checkAnswer(userAnswer) {
                const correctAnswer = currentQuestion.card[currentQuestion.answer === 'term' ? 'term' : 'definition'];
                
                // Simple check (case-insensitive)
                const isCorrect = userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
                
                if (isCorrect) {
                    correctCount++;
                    feedbackTitle.textContent = "Correct!";
                    feedbackBox.className = "p-6 rounded-lg shadow-xl bg-green-100 dark:bg-green-900";
                    feedbackTitle.className = "text-2xl font-bold text-green-800 dark:text-green-300";
                    feedbackAnswer.textContent = correctAnswer;
                } else {
                    incorrectQueue.push(currentQuestion); // Add back to incorrect queue
                    feedbackTitle.textContent = "Incorrect";
                    feedbackBox.className = "p-6 rounded-lg shadow-xl bg-red-100 dark:bg-red-900";
                    feedbackTitle.className = "text-2xl font-bold text-red-800 dark:text-red-300";
                    feedbackAnswer.innerHTML = `
                        <span class="text-sm block text-gray-700 dark:text-gray-400">Your answer:</span>
                        <span class="text-gray-900 dark:text-gray-200">${userAnswer}</span>
                        <br>
                        <span class="text-sm block text-gray-700 dark:text-gray-400 mt-2">Correct answer:</span>
                        <span class="text-gray-900 dark:text-gray-200">${correctAnswer}</span>
                    `;
                }
                
                // Show feedback
                questionCard.classList.add('hidden');
                feedbackCard.classList.remove('hidden');
                updateStats();
            }

            // --- Load data ---
            const fetchSet = async () => {
                try {
                  const docRef = doc(db, "studySets", setId);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    allCards = docSnap.data().cards;
                    if (allCards.length === 0) throw new Error("This set has no cards.");
                    titleEl.textContent = `Learn: ${docSnap.data().title}`;
                    
                    // Start session
                    buildSession(allCards);
                    nextQuestion();
                    
                    loadingEl.classList.add('hidden');
                  } else {
                    throw new Error("Study set not found.");
                  }
                } catch (err) {
                  console.error("Error fetching set:", err);
                  errorEl.textContent = "Failed to load learn session: " + err.message;
                  errorEl.classList.remove('hidden');
                  loadingEl.classList.add('hidden');
                }
            };
            fetchSet();
            
            // --- Attach Listeners ---
            backBtn.addEventListener('click', () => navigate('learnSetup', setId));
            
            typedArea.addEventListener('submit', (e) => {
                e.preventDefault();
                checkAnswer(typedInput.value);
            });
            
            feedbackNextBtn.addEventListener('click', nextQuestion);
            
            restartBtn.addEventListener('click', () => {
                completeModal.classList.add('hidden');
                buildSession(allCards);
                nextQuestion();
            });
            completeBackBtn.addEventListener('click', () => navigate('dashboard'));
        }
        
        // --- UPLOAD PAGE (Client-side AI) ---
        function UploadPageHTML() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                        ${IconAI()}
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mt-4 mb-4">Import & Auto-Create</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                          Upload a \`.txt\` or \`.pdf\` file and our AI will
                          automatically create flashcards for you.
                        </p>
                
                        <div class="p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                          <label 
                            for="file-upload" 
                            class="cursor-pointer inline-flex items-center px-6 py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
                          >
                            <span id="file-upload-icon">${IconUpload()}</span>
                            <span class="ml-2" id="file-upload-text">Select a file</span>
                          </label>
                          <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".pdf,.txt" />
                          
                          <p id="file-name" class="mt-4 text-sm text-gray-600 dark:text-gray-400 hidden"></p>
                        </div>
                        
                        <button
                          id="upload-btn"
                          disabled
                          class="w-full mt-8 px-6 py-3 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                        >
                          Generate Flashcards
                        </button>
                        
                        <p id="upload-message" class="mt-4 text-sm"></p>
                        
                        <div class="mt-8 p-4 bg-blue-50 dark:bg-gray-700 border border-blue-200 dark:border-blue-900 rounded-lg text-left">
                          <h4 class="font-semibold text-blue-800 dark:text-blue-300">How this works:</h4>
                          <p class="text-sm text-blue-700 dark:text-blue-400 mt-2">
                            1. Your browser reads the file (it's never uploaded to a server).
                          </p>
                          <p class="text-sm text-blue-700 dark:text-blue-400 mt-2">
                            2. The text is sent to the Google Gemini AI.
                          </p>
                           <p class="text-sm text-blue-700 dark:text-blue-400 mt-2">
                            3. The AI generates your flashcards and they are saved to your account!
                          </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function attachUploadListeners() {
            const fileInput = document.getElementById('file-upload');
            const fileNameEl = document.getElementById('file-name');
            const uploadBtn = document.getElementById('upload-btn');
            const messageEl = document.getElementById('upload-message');
            const uploadText = document.getElementById('file-upload-text');
            const uploadIcon = document.getElementById('file-upload-icon');
            
            let selectedFile = null;

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                  selectedFile = e.target.files[0];
                  fileNameEl.textContent = `Selected: ${selectedFile.name}`;
                  fileNameEl.classList.remove('hidden');
                  uploadBtn.disabled = false;
                  uploadText.textContent = 'Change file';
                }
            });

            uploadBtn.addEventListener('click', async () => {
                if (!selectedFile) return;

                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Processing...';
                uploadIcon.innerHTML = `<div class="w-5 h-5 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>`;
                messageEl.textContent = 'Reading your file...';
                messageEl.className = 'mt-4 text-sm text-blue-600 dark:text-blue-400';

                try {
                    let fileText = '';
                    
                    // 1. Read the file
                    if (selectedFile.type === 'application/pdf') {
                        messageEl.textContent = 'Reading PDF... (this might take a moment)';
                        const fileReader = new FileReader();
                        fileReader.onload = async (event) => {
                            const typedArray = new Uint8Array(event.target.result);
                            try {
                                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                                let text = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    text += textContent.items.map(item => item.str).join(' ') + '\n';
                                }
                                fileText = text;
                                await generateCards(fileText);
                            } catch (pdfErr) {
                                throw new Error("Could not read this PDF file. It might be corrupted or image-based.");
                            }
                        };
                        fileReader.readAsArrayBuffer(selectedFile);
                    } else {
                        // Plain text
                        fileText = await selectedFile.text();
                        await generateCards(fileText);
                    }

                } catch (err) {
                    console.error("Error during upload/AI process:", err);
                    messageEl.textContent = `Error: ${err.message}`;
                    messageEl.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Generate Flashcards';
                    uploadIcon.innerHTML = IconUpload();
                }
            });
            
            async function generateCards(text) {
                if (text.trim().length < 50) {
                    throw new Error("The document is too short. It must have at least 50 characters of text.");
                }
                
                messageEl.textContent = 'Contacting AI...';
                
                // 2. Call Gemini AI
                const prompt = `
                    You are an expert study assistant.
                    Analyze the following text and extract the most important key terms and their definitions.
                    The text is from a file named "${selectedFile.name}".
                    Return your answer as a valid JSON array of objects, where each object has a "term" and "definition" key.
                    
                    Example: [{"term": "Mitochondria", "definition": "The powerhouse of the cell."}]
                    
                    If you cannot find any good terms, return an empty array [].
                    Do not return more than 50 cards.
                    
                    Text to analyze:
                    ---
                    ${text.substring(0, 40000)}
                    ---
                `;
                
                // NOTE: This uses the client-side key. NOT SECURE for production.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      contents: [{ parts: [{ text: prompt }] }],
                      generationConfig: {
                        responseMimeType: "application/json",
                      }
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(errorBody.error?.message || "Failed to call AI. Check your API key and billing.");
                }

                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                
                let cards;
                try {
                    // The AI response might be wrapped in ```json ... ```
                    const cleanJson = jsonText.replace(/^```json|```$/g, "").trim();
                    cards = JSON.parse(cleanJson);
                } catch (e) {
                    console.error("Failed to parse JSON from AI:", jsonText);
                    throw new Error("The AI returned an invalid response. Please try again.");
                }

                if (!cards || cards.length === 0) {
                    throw new Error("The AI couldn't find any flashcards in that document.");
                }

                messageEl.textContent = 'Saving your new set...';

                // 3. Save to Firestore
                const newSet = {
                  title: `AI Set: ${selectedFile.name.replace(/\.[^/.]+$/, "")}`,
                  description: `Generated from file: ${selectedFile.name}`,
                  ownerId: globalUser.uid,
                  ownerEmail: globalUser.email,
                  isPublic: false, // Default to private
                  cards: cards,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp(),
                };
                
                const docRef = await addDoc(collection(db, "studySets"), newSet);
                
                messageEl.textContent = `Success! Created a new set with ${cards.length} cards.`;
                messageEl.className = 'mt-4 text-sm text-green-600 dark:text-green-400';
                
                // Reset form
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Generate Flashcards';
                uploadIcon.innerHTML = IconUpload();
                fileInput.value = null;
                selectedFile = null;
                fileNameEl.classList.add('hidden');
                
                // Navigate to new set
                setTimeout(() => {
                    navigate('edit', docRef.id);
                }, 2000);
            }
        }

        // --- AUTHENTICATION LISTENER (The App's "Start" button) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                globalUser = user;
                if (currentPage === 'auth') {
                    currentPage = 'dashboard';
                }
            } else {
                globalUser = null;
                currentPage = 'auth';
            }
            globalAuthLoaded = true;
            render();
        });

    </script>
</body>
</html>
